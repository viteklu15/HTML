<!DOCTYPE html>
<html lang="ru">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <title>ТКС «ОРИОН» - Панель управления</title>
  <link rel="stylesheet" href="globals.css" />
  <link rel="stylesheet" href="styleguide.css" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="screen">
    <header class="frame">
      <div class="div">
        <h1 class="text-wrapper">ТКС «ОРИОН»</h1>
      </div>
      <div id="system-badge" class="badge badge--pending" role="status" aria-label="Статус системы: Ожидание данных">
        <div class="ellipse" aria-hidden="true"></div>
        <span class="text-wrapper-2">Ожидание данных</span>
      </div>

      <div class="frame-2">
        <p class=" value-view ">
          <span id="current-temp" class="span">Температура: —℃</span>
        </p>

        <div id="mac-address" class="div-2">MAC-адрес: —</div>
      </div>
      <div class="frame-3">
        <div class="wi-fi" id="wifi-status-text">WiFi: ожидание…</div>

        <fieldset class="thumbler" role="radiogroup" aria-labelledby="wifi-status">
          <legend id="wifi-status" class="sr-only">Статус WiFi</legend>

          <!-- подложка-ползунок -->
          <div class="thumbler__knob" aria-hidden="true"></div>

          <label class="thumbler__option thumbler__option--left">
            <input type="radio" name="wifi-toggle" value="off" class="sr-only" />
            <span>Выкл</span>
          </label>

          <label class="thumbler__option thumbler__option--right">
            <input type="radio" name="wifi-toggle" value="on" class="sr-only" />
            <span>Вкл</span>
          </label>
        </fieldset>
      </div>

    </header>

    <div class="frame-wrapper">
      <div class="frame-4">
        <section class="frame-5" aria-label="Статус системы">
          <article id="power-status-card" class="frame-6 status-card">
            <svg id="power-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="power-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Питание</h3>
              <div id="power-status-text" class="text-wrapper-4">Ожидание…</div>
            </div>
          </article>
          <article id="coords-status-card" class="frame-9 status-card">
            <svg id="coords-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="coords-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Координаты</h3>
              <p class="element">
                <span id="coords-compact" class="text-wrapper-5">Ш: —; Д: —</span>
                <br> <span id="coords-status-text" class="text-wrapper-6">Определяем…</span>
              </p>

            </div>
          </article>

          <article id="gps-status-card" class="frame-9 status-card">
            <svg id="gps-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="gps-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Связь<br />со спутником</h3>
              <div id="gps-status-text" class="text-wrapper-4">Подключаем…</div>
            </div>
          </article>

          <article id="inet-status-card" class="frame-9 status-card">
            <svg id="inet-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="inet-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Интернет</h3>
              <div id="inet-status-text" class="text-wrapper-4">Подключаем…</div>
            </div>
          </article>

          <article id="rx-status-card" class="frame-10 status-card">
            <div id="rx-progress-bar" class="frame-11" role="progressbar" aria-valuenow="0" aria-valuemin="0"
              aria-valuemax="100" aria-label="Приём данных —%">
              <div id="rx-progress-fill" class="rectangle"></div>
              <div id="rx-progress-rest" class="rectangle-2"></div>
            </div>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Приём данных</h3>
              <p class="p"><span id="rx-progress-text" class="text-wrapper-7">0%</span></p>
            </div>
          </article>

          <article id="tx-status-card" class="frame-12 status-card">
            <div id="tx-progress-bar" class="frame-11" role="progressbar" aria-valuenow="0" aria-valuemin="0"
              aria-valuemax="100" aria-label="Передача данных —%">
              <div id="tx-progress-fill" class="rectangle"></div>
              <div id="tx-progress-rest" class="rectangle-2"></div>
            </div>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Передача данных</h3>
              <p class="p"><span id="tx-progress-text" class="text-wrapper-7">0%</span></p>
            </div>
          </article>
        </section>

        <section class="frame-13" aria-label="Детали подключения и управление">
          <div class="frame-14">

            <section id="connection-attempt" class="connection-attempt" hidden>
              <h2 class="connection-attempt__title">Идёт подключение…</h2>
              <p class="connection-attempt__attempt">Попытка <span id="connection-attempt-number">1</span> из <span id="connection-attempt-total">3</span></p>
              <p id="connection-attempt-eta-wrapper" class="connection-attempt__eta">Подождите ~<span id="connection-attempt-eta">3</span> мин</p>
            </section>

            <section id="connection-details" class="frame-15">
              <h2 class="text-wrapper-9">Детали подключения</h2>

              <div class="frame-16">

                <div class="frame-17" id="row-coords">
                  <div class="div-wrapper">
                    <label class="text-wrapper-10" for="lat">Координаты</label>
                  </div>

                  <!-- Просмотр -->
                  <p class="span-wrapper value-view">
                    <span id="coords-detailed" class="span"> Широта: —; Долгота: —</span>
                  </p>

                  <!-- Чекбокс -->
                  <div class="checkbox-w-label">
                    <input type="checkbox" id="edit-coordinates" class="checkbox-input sr-only" />
                    <label for="edit-coordinates" class="checkbox">
                      <div class="rectangle-3"></div>
                    </label>
                    <label for="edit-coordinates" class="label"><span class="title-3">Изменить</span></label>
                  </div>

                  <form class="edit-area" aria-label="Редактирование координат">
                    <div class="input-group">
                      <label for="lat">Широта</label>
                      <input id="lat" name="lat" type="text" inputmode="decimal" class="input" value="">
                    </div>

                    <span class="input-dash" aria-hidden="true">—</span>

                    <div class="input-group">
                      <label for="lng">Долгота</label>
                      <input id="lng" name="lng" type="text" inputmode="decimal" class="input" value="">
                    </div>

                    <span class="spacer" aria-hidden="true"></span>
                    <button class="btn btn-primary btn-save" type="submit">Сохранить</button>
                    <button class="btn btn-secondary btn-cancel" type="button">Отменить</button>
                  </form>

                </div>


                <div class="separator" aria-hidden="true"></div>

                <!-- ===== Пароль Wi-Fi (редактирование по чекбоксу) ===== -->
                <div class="frame-17" id="row-wifi-pass">
                  <div class="div-wrapper">
                    <label class="text-wrapper-10" for="wifi-pass">Пароль на WiFi</label>
                  </div>

                  <!-- Просмотр -->
                  <p class="span-wrapper value-view">
                    <span class="span">12345678</span>
                  </p>

                  <!-- Переключатель -->
                  <div class="checkbox-w-label">
                    <input type="checkbox" id="edit-wifi-password" class="checkbox-input sr-only" />
                    <label for="edit-wifi-password" class="checkbox">
                      <div class="rectangle-3"></div>
                    </label>
                    <label for="edit-wifi-password" class="label"><span class="title-3">Изменить</span></label>
                  </div>

                  <!-- Редактор -->
                  <form class="edit-area" aria-label="Редактирование пароля Wi-Fi">
                    <input id="wifi-pass" name="wifi-pass" minlength="8" class="input"
                      placeholder="Введите новый пароль" value="" aria-describedby="wifi-hint"
                      aria-label="Пароль Wi-Fi">
                    <span id="wifi-hint" class="hint">Минимум 8 символов</span>

                    <button class="btn btn-primary btn-save" type="submit">Сохранить</button>
                    <button class="btn btn-secondary btn-cancel" type="button">Отменить</button>
                  </form>
                </div>

                <!-- Остальные строки как были -->
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-17">
                  <div class="div-wrapper">
                    <p class="div-3">Номер луча в радио-частотном (РЧ) кластере</p>
                  </div>
                  <p class="span-wrapper"><span class="span">34</span></p>
                </div>
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-18">
                  <div class="div-wrapper">
                    <div class="text-wrapper-11">РЧ кластер / поляризация</div>
                  </div>
                  <p class="element-2"><span class="span">31 / А</span></p>
                </div>
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-19">
                  <div class="frame-20">
                    <div class="frame-21">
                      <div class="div-3">Температура модема</div>
                    </div>
                    <div class="state-default">
                      <div class="frame-11 meter" id="temp-meter" role="meter" aria-valuenow="-30" aria-valuemin="-30"
                        aria-valuemax="85" aria-label="Температура модема — данные не получены" data-pending="true">
                        <div class="rectangle rectangle-4 meter__fill"></div>
                        <div class="rectangle-2 meter__rest"></div>
                      </div>
                      <div class="frame-22">
                        <div class="text-wrapper-12">Низкая (-30℃)</div>
                        <div class="text-wrapper-13">Нормальная (+10℃)</div>
                        <div class="text-wrapper-14">Высокая (85℃)</div>
                      </div>
                    </div>
                  </div>
                  <!-- Блок рекомендаций при перегреве -->
                  <div id="temp-alert" class="temp-alert" role="region" aria-live="polite" hidden>
                    <div class="temp-alert__row">
                      <!-- маленькая иконка-warning -->
                      <svg class="temp-alert__icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2 1 21h22L12 2Zm1 14h-2v2h2v-2Zm0-8h-2v6h2V8Z" fill="currentColor" />
                      </svg>
                      <p id="temp-alert-text" class="temp-alert__text">
                        Рекомендуется выключить модем на время или укрыть / перенести его от прямых солнечных лучей
                      </p>
                    </div>

                    <div class="temp-alert__actions">
                      <button id="btn-shutdown-modem" type="button" class="btn btn-primary temp-alert__btn">
                        Выключить модем
                      </button>

                      <label class="temp-alert__auto">
                        <input id="auto-shutdown-hot" type="checkbox" class="temp-alert__checkbox" checked />
                        Выключать автоматически при опасных температурах
                      </label>
                    </div>
                  </div>

                </div>

              </div>
            </section>

            <section class="frame-15">
              <div class="frame-7">
                <h2 class="text-wrapper-15">Лог событий</h2>
                <p class="text-wrapper-16">Показано максимум 10 последних событий</p>
              </div>

              <div id="event-log" class="frame-23" role="log" aria-live="polite" aria-label="События системы">
                <p class="frame-23__empty text-wrapper-16">События отсутствуют</p>
              </div>
            </section>
          </div>

          <aside class="frame-26" aria-label="Углы наклона и поворота">
            <div class="frame-7">
              <h3 class="text-wrapper-19">Угол наклона (Азимута)</h3>
              <div class="frame-27">
                <!-- SVG как у вас -->
                <svg width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M49.1798 59.9657L37.8045 51.3335" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="2.2895" cy="2.2895" r="1.7895"
                    transform="matrix(-0.965926 0.258819 0.258819 0.965926 52.5015 58.3749)" stroke="#8C8C8C" />
                  <path d="M24.4533 59.8131L35.6758 51.3335" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="22.9032" cy="61.1789" r="1.7895" transform="rotate(15 22.9032 61.1789)"
                    stroke="#8C8C8C" />
                  <path d="M32.2376 59.2025L36.8166 51.2656" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="31.4506" cy="61.179" r="1.7895" transform="rotate(15 31.4506 61.179)" stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="9.68431" height="8.46325" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 35.6069 39.9205)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="19.1476" height="6.63165" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 35.4082 31.9626)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="26.9988" height="7.54745" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 31.4568 25.6283)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="2.35793" height="10.2948" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 38.8046 20.6906)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="6.93692" height="7.92708" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 50.3597 14.3517)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="5.43112" height="5.41059" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 44.9997 19.4697)" fill="white"
                    stroke="#8C8C8C" />
                  <path
                    d="M28.3346 9.51855C27.9145 9.99881 27.6462 10.7467 27.5775 11.7922C27.4907 13.1151 27.732 14.8213 28.2943 16.8051C29.4174 20.7673 31.7892 25.7281 35.1532 30.7341C38.5172 35.7399 42.214 39.8095 45.4581 42.3462C47.0825 43.6164 48.5711 44.4843 49.8288 44.9037C50.8227 45.2352 51.616 45.2683 52.2194 45.061C45.8813 35.6295 34.9843 19.4137 28.3346 9.51855Z"
                    fill="white" stroke="#8C8C8C" />
                  <line x1="0.5" y1="-0.5" x2="49.5636" y2="-0.5" transform="matrix(-1 0 0 1 62.3063 63.7815)"
                    stroke="#8C8C8C" stroke-linecap="round" />
                </svg>
                <div class="frame-28">
                  <div class="text-wrapper-20">Текущий — <span id="tilt-angle-current">—</span></div>
                  <div class="text-wrapper-21">Требуемый — <span id="tilt-angle-required">—</span></div>
                </div>
              </div>
            </div>

            <div class="frame-7">
              <h3 class="text-wrapper-19">Угол поворота</h3>
              <div class="frame-27">
                <div class="group-2">
                  <svg class="group-3" width="80" height="80" viewBox="0 0 56 56" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <rect x="-0.114869" y="0.585741" width="22.7168" height="13.6593" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 25.1881 21.1409)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="1.99005" height="8.75687" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 32.4403 18.6254)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="5.84168" height="6.74621" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 42.083 13.2011)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="4.57507" height="4.60925" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 37.6101 17.5807)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <path
                      d="M23.7014 9.06117C23.3494 9.47216 23.1239 10.1135 23.0664 11.0116C22.9939 12.1449 23.1956 13.6056 23.665 15.3039C24.6025 18.6957 26.5821 22.9419 29.3899 27.2265C32.1977 31.511 35.2837 34.9947 37.992 37.1664C39.348 38.2536 40.5907 38.9969 41.6413 39.3562C42.4738 39.6409 43.1377 39.6682 43.6417 39.4894C38.3519 31.4174 29.2516 17.5305 23.7014 9.06117Z"
                      fill="white" stroke="#8C8C8C" stroke-width="0.834486" />
                  </svg>
                  <div class="text-wrapper-22" aria-label="Север">N</div>
                  <div class="text-wrapper-23" aria-label="Юг">S</div>
                  <div class="text-wrapper-24" aria-label="Запад">W</div>
                  <div class="text-wrapper-25" aria-label="Восток">E</div>
                </div>
                <div class="frame-28">
                  <p class="element-3">
                    <span class="text-wrapper-26">Текущий — <span id="rotate-angle-current">—</span></span>
                  </p>
                  <div class="text-wrapper-21">Требуемый — <span id="rotate-angle-required">—</span></div>
                </div>
              </div>
            </div>
          </aside>
        </section>

        <footer class="footer">
          <div class="frame-29">
            <div class="text-wrapper-27">Версия ПО: 1.1</div>
            <button type="button" class="button-2">
              <span class="title-4">Обновить до 1.2</span>
            </button>
          </div>
          <div class="button-wrapper">
            <button type="button" class="button-2">
              <span class="title-4">Перенастроить модем</span>
            </button>
          </div>
        </footer>
      </div>
    </div>
  </main>

  <!-- Скрипт переключения режима редактирования -->
  <script>
    /* ===== Режим редактирования/просмотра по чекбоксам ===== */
    document.querySelectorAll('.checkbox-input').forEach(cb => {
      cb.addEventListener('change', e => {
        const row = e.target.closest('.frame-17');
        if (!row) return;
        row.classList.toggle('editing', e.target.checked);
        if (e.target.checked) {
          const firstInput = row.querySelector('.edit-area .input');
          if (firstInput) firstInput.focus();
        }
      });
    });

    document.querySelectorAll('.frame-17 .btn-cancel').forEach(btn => {
      btn.addEventListener('click', e => {
        const row = e.target.closest('.frame-17');
        const cb = row.querySelector('.checkbox-input');
        if (cb) { cb.checked = false; row.classList.remove('editing'); }
      });
    });

    document.querySelectorAll('.frame-17 form.edit-area').forEach(form => {
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const row = form.closest('.frame-17');

        if (row.id === 'row-coords') {
          const lat = form.querySelector('[name="lat"]').value.trim();
          const lng = form.querySelector('[name="lng"]').value.trim();
          row.querySelector('.value-view .span').textContent = `Широта: ${lat}; Долгота: ${lng}`;
          // await fetch('/api/coords', { ... });
          // Обновить компактный вывод в верхней карточке "Координаты"
          const compact = document.getElementById('coords-compact');
          if (compact) {
            compact.textContent = `Ш: ${lat}; Д: ${lng}`;
          }

        }

        if (row.id === 'row-wifi-pass') {
          const pass = form.querySelector('[name="wifi-pass"]').value;
          row.querySelector('.value-view .span').textContent = pass;
          // await fetch('/api/wifi', { ... });
        }

        const cb = row.querySelector('.checkbox-input');
        if (cb) { cb.checked = false; row.classList.remove('editing'); }
      });
    });

    /* ===== Тумблер Wi-Fi ===== */
    let updateWifiThumbler = null;
    (function () {
      const thumbler = document.querySelector('.thumbler');
      if (!thumbler) return;

      const radios = thumbler.querySelectorAll('input[name="wifi-toggle"]');
      const statusText = document.getElementById('wifi-status-text');

      function applyState(value) {
        const normalized = (value === 'on') ? 'on' : 'off';
        thumbler.classList.toggle('thumbler--on', normalized === 'on');
        thumbler.classList.toggle('thumbler--off', normalized === 'off');
        if (statusText) {
          statusText.textContent = (normalized === 'on') ? 'WiFi Работает' : 'WiFi Выключен';
        }
        radios.forEach(r => { r.checked = (r.value === normalized); });
      }

      updateWifiThumbler = applyState;

      radios.forEach(r => {
        r.addEventListener('change', (e) => {
          const v = e.target.value === 'on' ? 'on' : 'off';
          applyState(v);
          // fetch('/api/wifi', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ wifi_on: v === 'on' }) }).catch(console.error);
        });
      });
    })();

    /* ===== Статус системы (бейдж) ===== */
    const systemBadge = document.getElementById('system-badge');
    let systemStatusLocked = false;
    function setSystemStatus(kind, textOverride, options = {}) {
      if (!systemBadge) return;
      if (options.unlock) systemStatusLocked = false;
      const textMap = {
        pending: 'Подключаемся',
        ok: 'Всё работает',
        warn: 'Есть проблемы',
        err: 'Есть проблемы',
        off: 'Модем отключен'
      };
      const badgeClasses = ['badge--pending', 'badge--ok', 'badge--warn', 'badge--err', 'badge--off'];
      badgeClasses.forEach(cls => systemBadge.classList.remove(cls));

      const normalized = badgeClasses.some(cls => cls.endsWith(kind)) ? kind : 'pending';
      systemBadge.classList.add(`badge--${normalized}`);

      const text = textOverride || textMap[normalized] || '';
      const span = systemBadge.querySelector('.text-wrapper-2');
      if (span) span.textContent = text;
      systemBadge.setAttribute('aria-label', `Статус системы: ${text}`);
      if (options.lock) systemStatusLocked = true;
    }

    const STATUS_ICON_CLASSES = ['status-icon--pending', 'status-icon--ok', 'status-icon--err', 'status-icon--off'];
    const STATUS_ICON_CONFIG = {
      pending: { className: 'status-icon--pending', symbol: '#icon-status-ok', aria: 'Ожидание' },
      ok: { className: 'status-icon--ok', symbol: '#icon-status-ok', aria: 'ОК' },
      err: { className: 'status-icon--err', symbol: '#icon-status-err', aria: 'Ошибка' },
      off: { className: 'status-icon--off', symbol: '#icon-status-off', aria: 'Выключено' }
    };

    function setIndicatorState(indicator, status, textContent) {
      if (!indicator) return;
      const normalizedStatus = STATUS_ICON_CONFIG[status] ? status : 'pending';
      const config = STATUS_ICON_CONFIG[normalizedStatus];
      if (indicator.card) {
        indicator.card.dataset.status = normalizedStatus;
      }
      if (indicator.icon) {
        STATUS_ICON_CLASSES.forEach(cls => indicator.icon.classList.remove(cls));
        indicator.icon.classList.add(config.className);
        indicator.icon.setAttribute('aria-label', config.aria);
      }
      if (indicator.use) {
        indicator.use.setAttribute('href', config.symbol);
      }
      if (indicator.text && textContent != null) {
        indicator.text.textContent = textContent;
      }
      if (indicator.statusText && textContent != null) {
        indicator.statusText.textContent = textContent;
      }
    }

    function clampPercent(v) {
      const num = Number(v);
      if (Number.isNaN(num)) return 0;
      return Math.min(100, Math.max(0, num));
    }

    const indicators = {
      power: {
        card: document.getElementById('power-status-card'),
        icon: document.getElementById('power-status-icon'),
        use: document.getElementById('power-status-use'),
        text: document.getElementById('power-status-text')
      },
      coords: {
        card: document.getElementById('coords-status-card'),
        icon: document.getElementById('coords-status-icon'),
        use: document.getElementById('coords-status-use'),
        text: document.getElementById('coords-status-text'),
        compact: document.getElementById('coords-compact'),
        detailed: document.getElementById('coords-detailed'),
        inputs: {
          lat: document.getElementById('lat'),
          lng: document.getElementById('lng')
        }
      },
      gps: {
        card: document.getElementById('gps-status-card'),
        icon: document.getElementById('gps-status-icon'),
        use: document.getElementById('gps-status-use'),
        text: document.getElementById('gps-status-text')
      },
      inet: {
        card: document.getElementById('inet-status-card'),
        icon: document.getElementById('inet-status-icon'),
        use: document.getElementById('inet-status-use'),
        text: document.getElementById('inet-status-text')
      },
      rx: {
        bar: document.getElementById('rx-progress-bar'),
        fill: document.getElementById('rx-progress-fill'),
        rest: document.getElementById('rx-progress-rest'),
        value: document.getElementById('rx-progress-text')
      },
      tx: {
        bar: document.getElementById('tx-progress-bar'),
        fill: document.getElementById('tx-progress-fill'),
        rest: document.getElementById('tx-progress-rest'),
        value: document.getElementById('tx-progress-text')
      }
    };

    const angleFields = {
      tiltCurrent: document.getElementById('tilt-angle-current'),
      tiltRequired: document.getElementById('tilt-angle-required'),
      rotateCurrent: document.getElementById('rotate-angle-current'),
      rotateRequired: document.getElementById('rotate-angle-required')
    };
    // Стартовые значения прогресса = 0%
    updateProgressState(indicators.rx, 0, 'Приём данных');
    updateProgressState(indicators.tx, 0, 'Передача данных');
    const eventLog = document.getElementById('event-log');
    const logEmptyMessage = eventLog?.querySelector('.frame-23__empty') || null;
    const MAX_LOG_ENTRIES = 10;

    const macField = document.getElementById('mac-address');

    const connectionAttemptSection = document.getElementById('connection-attempt');
    const connectionDetailsSection = document.getElementById('connection-details');
    const connectionAttemptNumber = document.getElementById('connection-attempt-number');
    const connectionAttemptTotal = document.getElementById('connection-attempt-total');
    const connectionAttemptEta = document.getElementById('connection-attempt-eta');
    const connectionAttemptEtaWrapper = document.getElementById('connection-attempt-eta-wrapper');
    const ATTEMPT_TOTAL = 3;

    const COORDS_STATUS_LABELS = {
      pending: 'Определяем…',
      ok: 'Определены',
      err: 'Ошибка'
    };
    const SIMPLE_STATUS_LABELS = {
      pending: 'Подключаем…',
      ok: 'Есть',
      err: 'Нет связи'
    };
    const INTERNET_STATUS_LABELS = {
      pending: 'Подключаем…',
      ok: 'Подключён',
      err: 'Нет соединения'
    };

    function updateProgressState(indicator, progress, labelPrefix) {
      if (!indicator?.bar) return;
      const clamped = clampPercent(progress);
      if (indicator.fill) indicator.fill.style.flexGrow = String(clamped);
      if (indicator.rest) indicator.rest.style.flexGrow = String(100 - clamped);
      indicator.bar.setAttribute('aria-valuenow', String(clamped));
      indicator.bar.setAttribute('aria-label', `${labelPrefix} ${clamped}%`);
      if (indicator.value) {
        indicator.value.textContent = `${clamped}%`;
      }
    }

    function formatCoordinate(value, fractionDigits = 2) {
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      return num.toFixed(fractionDigits);
    }

    function formatAngle(value) {
      if (value == null || value === '') return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return String(value);
      return Number.isInteger(num) ? String(num) : num.toFixed(1);
    }

    function setAngleValue(el, value) {
      if (!el) return;
      el.textContent = formatAngle(value);
    }

    function parseLogTimestamp(raw) {
      if (typeof raw !== 'string') return null;
      const match = raw.trim().match(/^(\d{2})\.(\d{2})\.(\d{4}),\s*(\d{2}):(\d{2})$/);
      if (!match) return null;
      const [, dd, mm, yyyy, hh, min] = match;
      return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
    }

    function parseLogRecord(raw, fallbackIndex) {
      const text = raw == null ? '' : String(raw);
      const parts = text.split(/\n+/);
      const firstLine = (parts.shift() || '').trim();
      const numberMatch = firstLine.match(/^(\d+)\)\s*(.*)$/);
      const number = numberMatch ? (parseInt(numberMatch[1], 10) || fallbackIndex) : fallbackIndex;
      const messageRaw = numberMatch ? numberMatch[2] : firstLine;
      const message = (messageRaw && messageRaw.trim()) || '—';
      const timestampText = (parts.pop() || '').trim();
      return {
        number,
        message,
        timestampText,
        datetime: parseLogTimestamp(timestampText)
      };
    }

    function renderLogs(logs) {
      if (!eventLog) return;
      eventLog.querySelectorAll('article').forEach(node => node.remove());
      const items = Array.isArray(logs) ? logs.slice(0, MAX_LOG_ENTRIES) : [];
      if (items.length === 0) {
        if (logEmptyMessage) {
          logEmptyMessage.hidden = false;
          if (!logEmptyMessage.parentElement) {
            eventLog.appendChild(logEmptyMessage);
          }
        }
        return;
      }

      if (logEmptyMessage) {
        logEmptyMessage.hidden = true;
      }

      items.forEach((raw, index) => {
        const { number, message, timestampText, datetime } = parseLogRecord(raw, index + 1);
        const article = document.createElement('article');
        article.className = index === 0 ? 'frame-24' : 'frame-25';

        const numberEl = document.createElement('div');
        numberEl.className = 'text-wrapper-17';
        numberEl.textContent = String(number);

        const messageEl = document.createElement('p');
        messageEl.className = 'div-3';
        messageEl.textContent = message;

        article.appendChild(numberEl);
        article.appendChild(messageEl);

        if (timestampText) {
          const timeEl = document.createElement('time');
          timeEl.className = 'text-wrapper-18';
          timeEl.textContent = timestampText;
          if (datetime) {
            timeEl.setAttribute('datetime', datetime);
          }
          article.appendChild(timeEl);
        }

        eventLog.appendChild(article);
      });
    }

    function updateConnectionAttemptView(state) {
      if (!connectionAttemptSection) return;

      const rawAttempt = state?.attempt;
      const attemptTextRaw = rawAttempt == null ? '' : String(rawAttempt);
      const hasAttemptValue = attemptTextRaw.trim() !== '';

      if (!hasAttemptValue) {
        connectionAttemptSection.hidden = true;
        if (connectionDetailsSection) connectionDetailsSection.hidden = false;
        return;
      }

      const attemptNumber = Number(rawAttempt);
      const hasValidAttemptNumber = Number.isFinite(attemptNumber);
      const shouldShowAttempt = hasValidAttemptNumber && attemptNumber >= 0 && attemptNumber <= 2;
      const shouldShowDetails = hasValidAttemptNumber && attemptNumber === 4;

      if (shouldShowDetails || !shouldShowAttempt) {
        connectionAttemptSection.hidden = true;
        if (connectionDetailsSection) connectionDetailsSection.hidden = false;
        return;
      }

      connectionAttemptSection.hidden = false;
      if (connectionDetailsSection) connectionDetailsSection.hidden = true;

      const displayAttemptText = attemptNumber === 0 ? 'ноль' : attemptTextRaw;

      if (connectionAttemptNumber) {
        connectionAttemptNumber.textContent = displayAttemptText;
      }
      if (connectionAttemptTotal) {
        connectionAttemptTotal.textContent = String(ATTEMPT_TOTAL);
      }

      const etaSeconds = Number(state?.eta_sec);
      if (Number.isFinite(etaSeconds) && etaSeconds > 0) {
        const etaMinutes = Math.max(1, Math.round(etaSeconds / 60));
        if (connectionAttemptEta) {
          connectionAttemptEta.textContent = String(etaMinutes);
        }
        if (connectionAttemptEtaWrapper) connectionAttemptEtaWrapper.hidden = false;
      } else if (connectionAttemptEtaWrapper) {
        connectionAttemptEtaWrapper.hidden = true;
      }
    }

    /* ===== Пороги температуры ===== */
    const TEMP_WARN = 70;   // жёлтый
    const TEMP_ERR = 85;   // красный
    const TEMP_MIN = -30;  // как в подписи
    const TEMP_MAX = 85;

    /* ===== Обновление текста "Температура: +N℃" ===== */
    const spanTemp = document.getElementById('current-temp');
    function updateTemperatureField(tempC) {
      if (!spanTemp) return;
      const num = Number(tempC);
      if (Number.isNaN(num)) {
        spanTemp.textContent = 'Температура: —℃';
        return;
      }
      const formatted = Number.isInteger(num) ? Math.abs(num) : Math.abs(num).toFixed(1);
      const sign = num < 0 ? '−' : '+';
      spanTemp.textContent = `Температура: ${sign}${formatted}℃`;
    }

    /* ===== Полоса температуры (процент + цвет) ===== */
    const tempMeter = document.getElementById('temp-meter');
    const fillEl = tempMeter?.querySelector('.meter__fill');
    const restEl = tempMeter?.querySelector('.meter__rest');

    function clamp(v, a, b) { return Math.min(b, Math.max(a, v)); }

    function updateTempBar(tempC) {
      if (!tempMeter || !fillEl || !restEl) return;

      // ограничиваем только визуальное заполнение
      const p = (clamp(tempC, TEMP_MIN, TEMP_MAX) - TEMP_MIN) / (TEMP_MAX - TEMP_MIN);
      fillEl.style.flexGrow = String(p * 100);
      restEl.style.flexGrow = String((1 - p) * 100);

      tempMeter.classList.remove('meter--ok', 'meter--warn', 'meter--err');
      if (tempC >= TEMP_ERR) tempMeter.classList.add('meter--err');
      else if (tempC >= TEMP_WARN) tempMeter.classList.add('meter--warn');
      else tempMeter.classList.add('meter--ok');

      // aria — показываем реальную температуру
      tempMeter.setAttribute('aria-valuenow', String(Math.round(tempC)));
      tempMeter.setAttribute('aria-label', `Температура модема ${Math.round(tempC)} градусов`);
      tempMeter.removeAttribute('data-pending');
    }

    /* ===== Подсказки и статус по температуре ===== */
    const tempAlert = document.getElementById('temp-alert');
    const tempAlertText = document.getElementById('temp-alert-text');
    const btnShutdown = document.getElementById('btn-shutdown-modem');
    const cbAuto = document.getElementById('auto-shutdown-hot');

    function showOverheatAdvice(level, tempC) {
      if (!tempAlert) return;
      tempAlertText.textContent = (level === 'err')
        ? 'Опасная температура! Немедленно выключите модем или переместите его в прохладное место.'
        : 'Рекомендуется выключить модем на время или укрыть / перенести его от прямых солнечных лучей';
      tempAlert.hidden = false;
      tempAlert.setAttribute('aria-label', `Предупреждение о перегреве: ${Math.round(tempC)}℃`);
    }
    function hideOverheatAdvice() { if (tempAlert) tempAlert.hidden = true; }

    // флаг, чтобы авто-выключение отправлялось один раз на «красной» зоне
    let autoShutdownSent = false;

    async function shutdownModemSafely(isAuto = false) {
      try {
        // await fetch('/api/modem/power', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ on:false }) });
        setSystemStatus('off', 'Модем отключен', { lock: true });            // мгновенно в UI
        // НЕ скрываем предупреждение здесь — пусть пользователь видит причину
        if (btnShutdown) {
          btnShutdown.disabled = true;
          btnShutdown.textContent = isAuto ? 'Выключаем...' : 'Выключаем...';
        }
      } catch (e) {
        console.error('Не удалось выключить модем:', e);
        autoShutdownSent = false;
        if (btnShutdown) {
          btnShutdown.disabled = false;
          btnShutdown.textContent = 'Выключить модем';
        }
      }
    }
    btnShutdown?.addEventListener('click', () => shutdownModemSafely(false));

    function applyStatusByTemperature(tempC, { allowBadgeUpdate = true } = {}) {
      if (tempC == null || isNaN(tempC)) return;

      if (allowBadgeUpdate && !systemStatusLocked) {
        if (tempC >= TEMP_ERR) setSystemStatus('err');
        else if (tempC >= TEMP_WARN) setSystemStatus('warn');
        else setSystemStatus('ok');
      }

      if (tempC >= TEMP_ERR) showOverheatAdvice('err', tempC);
      else if (tempC >= TEMP_WARN) showOverheatAdvice('warn', tempC);
      else {
        hideOverheatAdvice();
        autoShutdownSent = false; // сброс, когда вернулись в норму
      }

      // авто-отключение: только один раз и не скрываем предупреждение
      if (cbAuto?.checked && tempC >= TEMP_ERR && !autoShutdownSent) {
        autoShutdownSent = true;
        shutdownModemSafely(true);
      }
    }

    /* ===== Инициализация из DOM-метра при загрузке ===== */
    (function initTempFromDOM() {
      const meter = document.querySelector('[role="meter"][aria-label*="Температура модема"]');
      if (!meter) return;
      if (meter.dataset.pending === 'true') return;
      const raw = meter.getAttribute('aria-valuenow');
      if (!raw) return;
      const now = parseFloat(raw);
      if (!Number.isNaN(now)) {
        updateTemperatureField(now);
        applyStatusByTemperature(now, { allowBadgeUpdate: !systemStatusLocked });
        updateTempBar(now);
      }
    })();

    /* ===== Точка входа новых данных от устройства =====
       Пример: window.onDeviceState({ temp_c: 72, modem_off:false })
    */
    window.onDeviceState = function (state) {
      if (!state) return;

      systemStatusLocked = false;

      if (typeof state.mac === 'string' && macField) {
        macField.textContent = `MAC-адрес: ${state.mac}`;
      }

      if ('power' in state) {
        const powerStatus = state.power === true ? 'ok' : (state.power === false ? 'off' : 'pending');
        const powerText = state.power === true ? 'Есть' : (state.power === false ? 'Нет' : 'Ожидание…');
        setIndicatorState(indicators.power, powerStatus, powerText);
      }

      if ('wifi_on' in state && typeof updateWifiThumbler === 'function') {
        updateWifiThumbler(state.wifi_on ? 'on' : 'off');
      }

      const coords = state.coords || {};
      if (indicators.coords) {
        const formattedLat = (coords.lat != null && coords.lat !== '') ? formatCoordinate(coords.lat) : '—';
        const formattedLng = (coords.lng != null && coords.lng !== '') ? formatCoordinate(coords.lng) : '—';
        if (indicators.coords.compact) {
          indicators.coords.compact.textContent = `Ш: ${formattedLat}; Д: ${formattedLng}`;
        }
        if (indicators.coords.detailed) {
          indicators.coords.detailed.textContent = ` Широта: ${formattedLat}; Долгота: ${formattedLng}`;
        }
        if (indicators.coords.inputs?.lat) {
          indicators.coords.inputs.lat.value = (coords.lat != null && coords.lat !== '') ? String(coords.lat) : '';
        }
        if (indicators.coords.inputs?.lng) {
          indicators.coords.inputs.lng.value = (coords.lng != null && coords.lng !== '') ? String(coords.lng) : '';
        }
      }

      if ('coords_status' in state && indicators.coords) {
        const status = ['pending', 'ok', 'err'].includes(state.coords_status) ? state.coords_status : 'pending';
        setIndicatorState(indicators.coords, status, COORDS_STATUS_LABELS[status] || COORDS_STATUS_LABELS.pending);
      }

      if ('gps_status' in state) {
        const status = ['pending', 'ok', 'err'].includes(state.gps_status) ? state.gps_status : 'pending';
        setIndicatorState(indicators.gps, status, SIMPLE_STATUS_LABELS[status] || SIMPLE_STATUS_LABELS.pending);
      }

      if ('inet_status' in state) {
        const status = ['pending', 'ok', 'err'].includes(state.inet_status) ? state.inet_status : 'pending';
        setIndicatorState(indicators.inet, status, INTERNET_STATUS_LABELS[status] || INTERNET_STATUS_LABELS.pending);
      }

      if (state.rx) {
        updateProgressState(indicators.rx, state.rx.progress, 'Приём данных');
      }

      if (state.tx) {
        updateProgressState(indicators.tx, state.tx.progress, 'Передача данных');
      }

      if (state.angles) {
        setAngleValue(angleFields.tiltCurrent, state.angles.tilt_current);
        setAngleValue(angleFields.tiltRequired, state.angles.tilt_required);
        setAngleValue(angleFields.rotateCurrent, state.angles.rotate_current);
        setAngleValue(angleFields.rotateRequired, state.angles.rotate_required);
      }

      if ('logs' in state) {
        renderLogs(state.logs);
      }

      updateConnectionAttemptView(state);

      if ('system' in state) {
        const knownStates = ['pending', 'ok', 'warn', 'err', 'off'];
        const normalized = knownStates.includes(state.system) ? state.system : 'pending';
        setSystemStatus(normalized, undefined, { lock: true });
      }

      if (state.modem_off) {
        setSystemStatus('off', 'Модем отключен', { lock: true });
      }

      if (state.temp_c != null) {
        const t = Number(state.temp_c);
        if (!Number.isNaN(t)) {
          updateTemperatureField(t);
          updateTempBar(t);
          applyStatusByTemperature(t, { allowBadgeUpdate: !systemStatusLocked });
        }
      }
    };

    /* ===== Пуллинг состояния с демо-сервером ===== */
    const API_STATE_URL = "http://127.0.0.1:8000/api/state";

    async function pollDeviceState() {
      try {
        const r = await fetch(API_STATE_URL, { cache: "no-store" });
        if (!r.ok) return;
        const data = await r.json();
        window.onDeviceState?.(data);
      } catch (e) {
        // console.debug("state poll error", e);
      }
    }
    pollDeviceState();
    setInterval(pollDeviceState, 2000);
  </script>


  <!-- SVG SPRITE -->
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="0" height="0"
    style="position:absolute;left:-9999px;">
    <defs>
      <symbol id="icon-status-ok" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="currentColor" />
        <path d="M6 12L10 16.5L18.5 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"
          stroke-linejoin="round" />
      </symbol>

      <symbol id="icon-status-err" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="currentColor" />
        <path d="M7 17.4497L17.4497 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" />
        <path d="M17.4497 17.4497L7 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" />
      </symbol>

      <symbol id="icon-status-off" viewBox="0 0 28 28">
        <circle cx="14" cy="14" r="13" fill="currentColor" stroke="#fff" stroke-width="2" />
        <path d="M8 14L12 18.5L20.5 9" stroke="#8C8C8C" stroke-width="2" fill="none" stroke-linecap="round"
          stroke-linejoin="round" />
      </symbol>
    </defs>
  </svg>

</body>

</html>