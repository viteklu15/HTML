<!DOCTYPE html>
<html lang="ru">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <title>ТКС «ОРИОН» - Панель управления</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="screen">
    <header class="frame">
      <div class="div">
        <h1 class="text-wrapper">ТКС «ОРИОН»</h1>
      </div>
      <div id="system-badge" class="badge badge--pending" role="status" aria-label="Статус системы: Ожидание данных">
        <div class="ellipse" aria-hidden="true"></div>
        <span class="text-wrapper-2">Ожидание данных</span>
      </div>

      <div class="frame-2">
        <p class=" value-view ">
          <span id="current-temp" class="span">Температура: —℃</span>
        </p>

        <div id="mac-address" class="div-2">MAC-адрес: —</div>
      </div>
      <div class="frame-3">
        <div class="wi-fi" id="wifi-status-text">WiFi: ожидание…</div>

        <fieldset class="thumbler thumbler--off" data-thumbler="wifi" role="radiogroup" aria-labelledby="wifi-status">
          <legend id="wifi-status" class="sr-only">Статус WiFi</legend>

          <!-- подложка-ползунок -->
          <div class="thumbler__knob" aria-hidden="true"></div>

          <label class="thumbler__option thumbler__option--left">
            <input type="radio" name="wifi-toggle" value="off" class="sr-only" />
            <span>Выкл</span>
          </label>

          <label class="thumbler__option thumbler__option--right">
            <input type="radio" name="wifi-toggle" value="on" class="sr-only" />
            <span>Вкл</span>
          </label>
        </fieldset>
      </div>

    </header>

    <div class="frame-wrapper">
      <div class="frame-4">
        <section class="frame-5" aria-label="Статус системы">
          <article id="power-status-card" class="frame-6 status-card">
            <svg id="power-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="power-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Питание</h3>
              <div id="power-status-text" class="text-wrapper-4">Ожидание…</div>
            </div>
          </article>
          <article id="coords-status-card" class="frame-9 status-card">
            <svg id="coords-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="coords-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Координаты</h3>
              <p class="element">
                <span id="coords-compact" class="text-wrapper-5">Ш: —; Д: —</span>
                <br> <span id="coords-status-text" class="text-wrapper-6">Определяем…</span>
              </p>

            </div>
          </article>

          <article id="gps-status-card" class="frame-9 status-card">
            <svg id="gps-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="gps-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Связь<br />со спутником</h3>
              <div id="gps-status-text" class="text-wrapper-4">Подключаем…</div>
            </div>
          </article>

          <article id="inet-status-card" class="frame-9 status-card">
            <svg id="inet-status-icon" class="status-icon status-icon--pending" role="img" aria-label="Ожидание">
              <use id="inet-status-use" href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Интернет</h3>
              <div id="inet-status-text" class="text-wrapper-4">Подключаем…</div>
            </div>
          </article>

          <article id="rx-status-card" class="frame-10 status-card">
            <div id="rx-progress-bar" class="frame-11" role="progressbar" aria-valuenow="0" aria-valuemin="0"
              aria-valuemax="100" aria-label="Приём данных —%">
              <div id="rx-progress-fill" class="rectangle"></div>
              <div id="rx-progress-rest" class="rectangle-2"></div>
            </div>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Приём данных</h3>
              <p class="p"><span id="rx-progress-text" class="text-wrapper-7">0%</span></p>
            </div>
          </article>

          <article id="tx-status-card" class="frame-12 status-card">
            <div id="tx-progress-bar" class="frame-11" role="progressbar" aria-valuenow="0" aria-valuemin="0"
              aria-valuemax="100" aria-label="Передача данных —%">
              <div id="tx-progress-fill" class="rectangle"></div>
              <div id="tx-progress-rest" class="rectangle-2"></div>
            </div>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Передача данных</h3>
              <p class="p"><span id="tx-progress-text" class="text-wrapper-7">0%</span></p>
            </div>
          </article>
        </section>

        <section class="frame-13" aria-label="Детали подключения и управление">
          <div class="frame-14">

            <section id="connection-details" class="frame-15">
              <h2 id="connection-details-title" class="text-wrapper-9">H2вариант 0</h2>
              <p id="connection-details-subtitle" class="connection-subtitle">Pвариант 0</p>

              <div class="frame-16">

                <div class="frame-17" id="row-coords">
                  <div class="div-wrapper">
                    <label class="text-wrapper-10" for="lat">Координаты</label>
                  </div>

                  <!-- Просмотр -->
                  <p class="span-wrapper value-view">
                    <span id="coords-detailed" class="span"> Широта: —; Долгота: —</span>
                  </p>

                  <!-- Чекбокс -->
                  <div class="checkbox-w-label">
                    <input type="checkbox" id="edit-coordinates" class="checkbox-input sr-only" />
                    <label for="edit-coordinates" class="checkbox">
                      <div class="rectangle-3"></div>
                    </label>
                    <label for="edit-coordinates" class="label"><span class="title-3">Изменить</span></label>
                  </div>

                  <form class="edit-area" aria-label="Редактирование координат">
                    <div class="input-group">
                      <label for="lat">Широта</label>
                      <input id="lat" name="lat" type="text" inputmode="decimal" class="input" value="">
                    </div>

                    <span class="input-dash" aria-hidden="true">—</span>

                    <div class="input-group">
                      <label for="lng">Долгота</label>
                      <input id="lng" name="lng" type="text" inputmode="decimal" class="input" value="">
                    </div>

                    <!-- <span class="spacer" aria-hidden="true"></span> -->
                    <button class="btn btn-primary btn-save" type="submit">Сохранить</button>
                    <button class="btn btn-secondary btn-cancel" type="button">Отменить</button>
                  </form>

                </div>


                <div class="separator" aria-hidden="true"></div>

                <!-- ===== Пароль Wi-Fi (редактирование по чекбоксу) ===== -->
                <div class="frame-17" id="row-wifi-pass">
                  <div class="div-wrapper">
                    <label class="text-wrapper-10" for="wifi-pass">Пароль на WiFi</label>
                  </div>

                  <!-- Просмотр -->
                  <p class="span-wrapper value-view">
                    <span class="span">12345678</span>
                  </p>

                  <!-- Переключатель -->
                  <div class="checkbox-w-label">
                    <input type="checkbox" id="edit-wifi-password" class="checkbox-input sr-only" />
                    <label for="edit-wifi-password" class="checkbox">
                      <div class="rectangle-3"></div>
                    </label>
                    <label for="edit-wifi-password" class="label"><span class="title-3">Изменить</span></label>
                  </div>

                  <!-- Редактор -->
                  <form class="edit-area" aria-label="Редактирование пароля Wi-Fi">
                    <input id="wifi-pass" name="wifi-pass" minlength="8" class="input"
                      placeholder="Введите новый пароль" value="" aria-describedby="wifi-hint"
                      aria-label="Пароль Wi-Fi">
                    <span id="wifi-hint" class="hint">Минимум 8 символов</span>

                    <button class="btn btn-primary btn-save" type="submit">Сохранить</button>
                    <button class="btn btn-secondary btn-cancel" type="button">Отменить</button>
                  </form>
                </div>

                <!-- Остальные строки как были -->
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-17">
                  <div class="div-wrapper">
                    <p class="div-3">Номер луча в радио-частотном (РЧ) кластере</p>
                  </div>
                  <p class="span-wrapper"><span id="beam-number-value" class="span">—</span></p>
                </div>
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-18">
                  <div class="div-wrapper">
                    <div class="text-wrapper-11">РЧ кластер / поляризация</div>
                  </div>
                  <p class="element-2"><span id="rf-cluster-polarization-value" class="span">—</span></p>
                </div>
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-19">
                  <div class="frame-20">
                    <div class="frame-21">
                      <div class="div-3">Температура модема</div>
                    </div>
                    <div class="state-default">
                      <div class="frame-11 meter" id="temp-meter" role="meter" aria-valuemin="-30" aria-valuemax="85"
                        aria-label="Температура модема — данные не получены" data-pending="true">
                        <div class="rectangle rectangle-4 meter__fill"></div>
                        <div class="rectangle-2 meter__rest"></div>
                      </div>
                      <div class="frame-22">
                        <div class="text-wrapper-12">Низкая (-30℃)</div>
                        <div class="text-wrapper-13">Нормальная (+10℃)</div>
                        <div class="text-wrapper-14">Высокая (85℃)</div>
                      </div>
                    </div>
                  </div>
                  <!-- Блок рекомендаций при перегреве -->
                  <div id="temp-alert" class="temp-alert" role="region" aria-live="polite" hidden>
                    <div class="temp-alert__row">
                      <!-- маленькая иконка-warning -->
                      <svg class="temp-alert__icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2 1 21h22L12 2Zm1 14h-2v2h2v-2Zm0-8h-2v6h2V8Z" fill="currentColor" />
                      </svg>
                      <p id="temp-alert-text" class="temp-alert__text">
                        Рекомендуется выключить модем на время или укрыть / перенести его от прямых солнечных лучей
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="modem-controls" aria-labelledby="modem-controls-title">
              <h3 id="modem-controls-title" class="sr-only">Управление питанием модема</h3>
              <div class="temp-alert__actions modem-controls__row">
                <div class="modem-controls__toggle">
                  <div id="modem-power-status" class="modem-controls__status">Модем:</div>

                  <fieldset class="thumbler thumbler--off" data-thumbler="modem" role="radiogroup"
                    aria-labelledby="modem-power-status">
                    <legend class="sr-only">Питание модема</legend>
                    <div class="thumbler__knob" aria-hidden="true"></div>

                    <label class="thumbler__option thumbler__option--left">
                      <input type="radio" name="modem-power-toggle" value="off" class="sr-only" />
                      <span>Выкл</span>
                    </label>

                    <label class="thumbler__option thumbler__option--right">
                      <input type="radio" name="modem-power-toggle" value="on" class="sr-only" />
                      <span>Вкл</span>
                    </label>
                  </fieldset>
                </div>

                <div class="temp-alert__auto checkbox-w-label">
                  <input id="auto-shutdown-hot" type="checkbox" class="checkbox-input sr-only" />
                  <label for="auto-shutdown-hot" class="checkbox">
                    <div class="rectangle-3"></div>
                  </label>
                  <label for="auto-shutdown-hot" class="label temp-alert__auto-label">
                    <span class="title-3">Выключать автоматически при опасных температурах</span>
                  </label>
                </div>
              </div>
            </section>

            <section class="frame-15">
              <div class="frame-7">
                <h2 class="text-wrapper-15">Лог событий</h2>
                <p class="text-wrapper-16">Показано максимум 10 последних событий</p>
              </div>

              <div id="event-log" class="frame-23" role="log" aria-live="polite" aria-label="События системы">
                <p class="frame-23__empty text-wrapper-16">События отсутствуют</p>
              </div>
            </section>
          </div>

          <aside class="frame-26" aria-label="Углы наклона и поворота">
            <div class="frame-7">
              <h3 class="text-wrapper-19">Угол наклона (Угол места)</h3>
              <div class="frame-27">
                <!-- SVG как у вас -->
                <svg width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M49.1798 59.9657L37.8045 51.3335" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="2.2895" cy="2.2895" r="1.7895"
                    transform="matrix(-0.965926 0.258819 0.258819 0.965926 52.5015 58.3749)" stroke="#8C8C8C" />
                  <path d="M24.4533 59.8131L35.6758 51.3335" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="22.9032" cy="61.1789" r="1.7895" transform="rotate(15 22.9032 61.1789)"
                    stroke="#8C8C8C" />
                  <path d="M32.2376 59.2025L36.8166 51.2656" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="31.4506" cy="61.179" r="1.7895" transform="rotate(15 31.4506 61.179)" stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="9.68431" height="8.46325" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 35.6069 39.9205)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="19.1476" height="6.63165" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 35.4082 31.9626)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="26.9988" height="7.54745" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 31.4568 25.6283)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="2.35793" height="10.2948" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 38.8046 20.6906)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="6.93692" height="7.92708" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 50.3597 14.3517)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="5.43112" height="5.41059" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 44.9997 19.4697)" fill="white"
                    stroke="#8C8C8C" />
                  <path
                    d="M28.3346 9.51855C27.9145 9.99881 27.6462 10.7467 27.5775 11.7922C27.4907 13.1151 27.732 14.8213 28.2943 16.8051C29.4174 20.7673 31.7892 25.7281 35.1532 30.7341C38.5172 35.7399 42.214 39.8095 45.4581 42.3462C47.0825 43.6164 48.5711 44.4843 49.8288 44.9037C50.8227 45.2352 51.616 45.2683 52.2194 45.061C45.8813 35.6295 34.9843 19.4137 28.3346 9.51855Z"
                    fill="white" stroke="#8C8C8C" />
                  <line x1="0.5" y1="-0.5" x2="49.5636" y2="-0.5" transform="matrix(-1 0 0 1 62.3063 63.7815)"
                    stroke="#8C8C8C" stroke-linecap="round" />
                </svg>
                <div class="frame-28">
                  <div class="text-wrapper-20 angle-status angle-status--mismatch" data-angle-status>Текущий — <span
                      id="tilt-angle-current">—</span></div>
                  <div class="text-wrapper-21">Требуемый — <span id="tilt-angle-required">—</span></div>
                </div>
              </div>
            </div>

            <div class="frame-7">
              <h3 class="text-wrapper-19">Угол поворота (Азимута)</h3>
              <div class="frame-27">
                <div class="group-2">
                  <svg class="group-3" width="80" height="80" viewBox="0 0 56 56" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <rect x="-0.114869" y="0.585741" width="22.7168" height="13.6593" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 25.1881 21.1409)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="1.99005" height="8.75687" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 32.4403 18.6254)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="5.84168" height="6.74621" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 42.083 13.2011)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="4.57507" height="4.60925" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 37.6101 17.5807)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <path
                      d="M23.7014 9.06117C23.3494 9.47216 23.1239 10.1135 23.0664 11.0116C22.9939 12.1449 23.1956 13.6056 23.665 15.3039C24.6025 18.6957 26.5821 22.9419 29.3899 27.2265C32.1977 31.511 35.2837 34.9947 37.992 37.1664C39.348 38.2536 40.5907 38.9969 41.6413 39.3562C42.4738 39.6409 43.1377 39.6682 43.6417 39.4894C38.3519 31.4174 29.2516 17.5305 23.7014 9.06117Z"
                      fill="white" stroke="#8C8C8C" stroke-width="0.834486" />
                  </svg>
                  <div class="text-wrapper-22" aria-label="Север">N</div>
                  <div class="text-wrapper-23" aria-label="Юг">S</div>
                  <div class="text-wrapper-24" aria-label="Запад">W</div>
                  <div class="text-wrapper-25" aria-label="Восток">E</div>
                </div>
                <div class="frame-28">
                  <p class="element-3">
                    <span class="text-wrapper-26 angle-status angle-status--mismatch" data-angle-status>Текущий — <span
                        id="rotate-angle-current">—</span></span>
                  </p>
                  <div class="text-wrapper-21">Требуемый — <span id="rotate-angle-required">—</span></div>
                </div>
              </div>
            </div>
          </aside>
        </section>

        <footer class="footer">
          <div class="frame-29">
            <div class="text-wrapper-27">Версия ПО: 1.1</div>
            <button type="button" class="button-2">
              <span class="title-4">Обновить до 1.2</span>
            </button>
          </div>
          <div class="button-wrapper">
            <button type="button" class="button-2">
              <span class="title-4">Перенастроить модем</span>
            </button>
          </div>
        </footer>
      </div>
    </div>
  </main>

  <!-- Скрипт переключения режима редактирования -->
  <script>
    const API_BASE_URL = window.location.origin;
    const API_WIFI_COMMAND_ENDPOINT = "/api/wifi";
    const API_COORDS_SAVE_ENDPOINT = "/api/coords/save";
    const API_WIFI_PASSWORD_ENDPOINT = "/api/wifi/password";
    const API_MODEM_POWER_ENDPOINT = "/api/modem/power";
    const API_MODEM_AUTO_SHUTDOWN_ENDPOINT = "/api/modem/off-temp";

    const STATE_POLL_INTERVAL_MS = 500;
    let statePollTimerId = null;

    const wifiStatusElement = document.getElementById('wifi-status-text');
    let resetWifiThumblerToInitial = null;
    let setWifiThumblerDisabled = null;

    function restartStatePollingTimer() {
      if (statePollTimerId !== null) {
        clearInterval(statePollTimerId);
      }
      statePollTimerId = setInterval(pollDeviceState, STATE_POLL_INTERVAL_MS);
    }

    async function sendLocalGet(path, params = {}) {
      try {
        const url = new URL(path, API_BASE_URL);
        Object.entries(params).forEach(([key, value]) => {
          if (value != null) {
            url.searchParams.set(key, value);
          }
        });
        await fetch(url.toString(), { method: 'GET', cache: 'no-store' });
      } catch (error) {
        console.error('Не удалось выполнить локальный GET-запрос', error);
      } finally {
        restartStatePollingTimer();
      }
    }

    /* ===== Режим редактирования/просмотра по чекбоксам ===== */
    document.querySelectorAll('.checkbox-input').forEach(cb => {
      cb.addEventListener('change', e => {
        const row = e.target.closest('.frame-17');
        if (!row) return;
        row.classList.toggle('editing', e.target.checked);
        if (e.target.checked) {
          const firstInput = row.querySelector('.edit-area .input');
          if (firstInput) firstInput.focus();
        }
      });
    });

    document.querySelectorAll('.frame-17 .btn-cancel').forEach(btn => {
      btn.addEventListener('click', e => {
        const row = e.target.closest('.frame-17');
        const cb = row.querySelector('.checkbox-input');
        if (cb) { cb.checked = false; row.classList.remove('editing'); }
      });
    });

    document.querySelectorAll('.frame-17 form.edit-area').forEach(form => {
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const row = form.closest('.frame-17');

        if (row.id === 'row-coords') {
          const lat = form.querySelector('[name="lat"]').value.trim();
          const lng = form.querySelector('[name="lng"]').value.trim();
          row.querySelector('.value-view .span').textContent = `Широта: ${lat}; Долгота: ${lng}`;
          const compact = document.getElementById('coords-compact');
          if (compact) compact.textContent = `Ш: ${lat}; Д: ${lng}`;
          await sendLocalGet(API_COORDS_SAVE_ENDPOINT, { lat, lng });
        }

        if (row.id === 'row-wifi-pass') {
          const pass = form.querySelector('[name="wifi-pass"]').value;
          row.querySelector('.value-view .span').textContent = pass;
          await sendLocalGet(API_WIFI_PASSWORD_ENDPOINT, { password: pass });
        }

        const cb = row.querySelector('.checkbox-input');
        if (cb) { cb.checked = false; row.classList.remove('editing'); }
      });
    });

    /* ===== Тумблер Wi-Fi ===== */
    let updateWifiThumbler = null;
    (function () {
      const thumbler = document.querySelector('[data-thumbler="wifi"]');
      if (!thumbler) return;

      const radios = Array.from(thumbler.querySelectorAll('input[name="wifi-toggle"]'));
      const statusText = wifiStatusElement;

      const initialThumblerClassName = thumbler.className;
      const initialStatusText = statusText?.textContent || '';
      const initialRadiosChecked = radios.map(radio => radio.checked);
      const initialRadiosDisabled = radios.map(radio => radio.disabled);
      const initialThumblerAriaDisabled = thumbler.getAttribute('aria-disabled');

      resetWifiThumblerToInitial = function () {
        thumbler.className = initialThumblerClassName;
        if (initialThumblerAriaDisabled != null) thumbler.setAttribute('aria-disabled', initialThumblerAriaDisabled);
        else thumbler.removeAttribute('aria-disabled');
        radios.forEach((radio, index) => {
          radio.checked = Boolean(initialRadiosChecked[index]);
          radio.disabled = Boolean(initialRadiosDisabled[index]);
        });
        if (statusText) statusText.textContent = initialStatusText;
      };

      function applyState(value) {
        const normalized = (value === 'on') ? 'on' : 'off';
        thumbler.classList.toggle('thumbler--on', normalized === 'on');
        thumbler.classList.toggle('thumbler--off', normalized === 'off');
        if (statusText) {
          statusText.textContent = (normalized === 'on') ? 'WiFi Работает' : 'WiFi Выключен';
        }
        radios.forEach(r => { r.checked = (r.value === normalized); });
      }

      function setDisabled(disabled) {
        radios.forEach(radio => { radio.disabled = disabled; });
        thumbler.classList.toggle('thumbler--disabled', disabled);
        if (disabled) thumbler.setAttribute('aria-disabled', 'true');
        else thumbler.removeAttribute('aria-disabled');
      }

      updateWifiThumbler = applyState;
      setWifiThumblerDisabled = setDisabled;

      radios.forEach(r => {
        r.addEventListener('change', (e) => {
          const v = e.target.value === 'on' ? 'on' : 'off';
          applyState(v);
          sendLocalGet(API_WIFI_COMMAND_ENDPOINT, { state: v });
        });
      });
    })();

    /* ===== Статус системы (бейдж) ===== */
    const systemBadge = document.getElementById('system-badge');
    let systemStatusLocked = false;
    function setSystemStatus(kind, textOverride, options = {}) {
      if (!systemBadge) return;
      if (options.unlock) systemStatusLocked = false;
      const textMap = {
        pending: 'Подключаемся',
        ok: 'Всё работает',
        warn: 'Есть проблемы',
        err: 'Есть проблемы',
        off: 'Модем отключен'
      };
      const badgeClasses = ['badge--pending', 'badge--ok', 'badge--warn', 'badge--err', 'badge--off'];
      badgeClasses.forEach(cls => systemBadge.classList.remove(cls));
      const normalized = ['pending', 'ok', 'warn', 'err', 'off'].includes(kind) ? kind : 'pending';
      systemBadge.classList.add(`badge--${normalized}`);
      const text = textOverride || textMap[normalized] || '';
      const span = systemBadge.querySelector('.text-wrapper-2');
      if (span) span.textContent = text;
      systemBadge.setAttribute('aria-label', `Статус системы: ${text}`);
      if (options.lock) systemStatusLocked = true;
    }

    const STATUS_ICON_CLASSES = ['status-icon--pending', 'status-icon--ok', 'status-icon--err', 'status-icon--off'];
    const STATUS_ICON_CONFIG = {
      pending: { className: 'status-icon--pending', symbol: '#icon-status-ok', aria: 'Ожидание' },
      ok: { className: 'status-icon--ok', symbol: '#icon-status-ok', aria: 'ОК' },
      err: { className: 'status-icon--err', symbol: '#icon-status-err', aria: 'Ошибка' },
      off: { className: 'status-icon--off', symbol: '#icon-status-off', aria: 'Выключено' }
    };

    function setIndicatorState(indicator, status, textContent) {
      if (!indicator) return;
      const normalizedStatus = STATUS_ICON_CONFIG[status] ? status : 'pending';
      const config = STATUS_ICON_CONFIG[normalizedStatus];
      if (indicator.card) indicator.card.dataset.status = normalizedStatus;
      if (indicator.icon) {
        STATUS_ICON_CLASSES.forEach(cls => indicator.icon.classList.remove(cls));
        indicator.icon.classList.add(config.className);
        indicator.icon.setAttribute('aria-label', config.aria);
      }
      if (indicator.use) indicator.use.setAttribute('href', config.symbol);
      if (indicator.text && textContent != null) indicator.text.textContent = textContent;
      if (indicator.statusText && textContent != null) indicator.statusText.textContent = textContent;
    }

    function clampPercent(v) {
      const num = Number(v);
      if (Number.isNaN(num)) return 0;
      return Math.min(100, Math.max(0, num));
    }

    const indicators = {
      power: {
        card: document.getElementById('power-status-card'),
        icon: document.getElementById('power-status-icon'),
        use: document.getElementById('power-status-use'),
        text: document.getElementById('power-status-text')
      },
      coords: {
        card: document.getElementById('coords-status-card'),
        icon: document.getElementById('coords-status-icon'),
        use: document.getElementById('coords-status-use'),
        text: document.getElementById('coords-status-text'),
        compact: document.getElementById('coords-compact'),
        detailed: document.getElementById('coords-detailed'),
        inputs: {
          lat: document.getElementById('lat'),
          lng: document.getElementById('lng')
        }
      },
      gps: {
        card: document.getElementById('gps-status-card'),
        icon: document.getElementById('gps-status-icon'),
        use: document.getElementById('gps-status-use'),
        text: document.getElementById('gps-status-text')
      },
      inet: {
        card: document.getElementById('inet-status-card'),
        icon: document.getElementById('inet-status-icon'),
        use: document.getElementById('inet-status-use'),
        text: document.getElementById('inet-status-text')
      },
      rx: {
        bar: document.getElementById('rx-progress-bar'),
        fill: document.getElementById('rx-progress-fill'),
        rest: document.getElementById('rx-progress-rest'),
        value: document.getElementById('rx-progress-text')
      },
      tx: {
        bar: document.getElementById('tx-progress-bar'),
        fill: document.getElementById('tx-progress-fill'),
        rest: document.getElementById('tx-progress-rest'),
        value: document.getElementById('tx-progress-text')
      }
    };

    const rows = {
      coords: document.getElementById('row-coords'),
      wifiPass: document.getElementById('row-wifi-pass')
    };

    const wifiPasswordView = rows.wifiPass?.querySelector('.value-view .span') || null;
    const wifiPasswordInput = document.getElementById('wifi-pass');

    const angleFields = {
      tiltCurrent: document.getElementById('tilt-angle-current'),
      tiltRequired: document.getElementById('tilt-angle-required'),
      rotateCurrent: document.getElementById('rotate-angle-current'),
      rotateRequired: document.getElementById('rotate-angle-required')
    };

    function isRowEditing(rowEl) {
      const checkbox = rowEl?.querySelector('.checkbox-input');
      return Boolean(checkbox?.checked);
    }

    // Стартовые значения прогресса = 0%
    updateProgressState(indicators.rx, 0, 'Приём данных');
    updateProgressState(indicators.tx, 0, 'Передача данных');

    const eventLog = document.getElementById('event-log');
    const logEmptyMessage = eventLog?.querySelector('.frame-23__empty') || null;
    const MAX_LOG_ENTRIES = 10;

    const macField = document.getElementById('mac-address');
    const beamNumberField = document.getElementById('beam-number-value');
    const rfClusterField = document.getElementById('rf-cluster-polarization-value');

    const connectionDetailsSection = document.getElementById('connection-details');
    const connectionDetailsTitle = document.getElementById('connection-details-title');
    const connectionDetailsSubtitle = document.getElementById('connection-details-subtitle');
    const CONNECTION_DETAIL_VARIANTS = [
      { title: 'H2вариант 0', subtitle: 'Pвариант 0' },
      { title: 'H2вариант 1', subtitle: 'Pвариант 1' },
      { title: 'H2вариант 2', subtitle: 'Pвариант 2' },
      { title: 'H2вариант 3', subtitle: 'Pвариант 3' },
      { title: 'H2вариант 4', subtitle: 'Pвариант 4' },
      { title: 'H2вариант 5', subtitle: 'Pвариант 5' },
      { title: 'H2вариант 6', subtitle: 'Pвариант 6' },
      { title: 'H2вариант 7', subtitle: 'Pвариант 7' },
      { title: 'H2вариант 8', subtitle: 'Pвариант 8' },
      { title: 'H2вариант 9', subtitle: 'Pвариант 9' },
      { title: 'H2вариант 10', subtitle: 'Pвариант 10' }
    ];
    const defaultConnectionDetails = {
      title: connectionDetailsTitle?.textContent || CONNECTION_DETAIL_VARIANTS[0].title,
      subtitle: connectionDetailsSubtitle?.textContent || CONNECTION_DETAIL_VARIANTS[0].subtitle
    };

    const initialIndicatorTexts = {
      power: indicators.power?.text?.textContent || '',
      coords: indicators.coords?.text?.textContent || '',
      gps: indicators.gps?.text?.textContent || '',
      inet: indicators.inet?.text?.textContent || ''
    };

    const initialCoordinatesView = {
      compact: indicators.coords?.compact?.textContent || '',
      detailed: indicators.coords?.detailed?.textContent || '',
      inputs: {
        lat: indicators.coords?.inputs?.lat?.value || '',
        lng: indicators.coords?.inputs?.lng?.value || ''
      }
    };

    const initialAngleTexts = {
      tiltCurrent: angleFields.tiltCurrent?.textContent || '',
      tiltRequired: angleFields.tiltRequired?.textContent || '',
      rotateCurrent: angleFields.rotateCurrent?.textContent || '',
      rotateRequired: angleFields.rotateRequired?.textContent || ''
    };

    const spanTempInitial = document.getElementById('current-temp');
    const tempMeterInitial = document.getElementById('temp-meter');
    const modemStatusInitial = document.getElementById('modem-power-status');
    const autoShutdownInitial = document.getElementById('auto-shutdown-hot');

    const initialViewState = {
      systemBadgeText: systemBadge?.querySelector('.text-wrapper-2')?.textContent || '',
      wifiStatusText: wifiStatusElement?.textContent || '',
      temperatureText: spanTempInitial?.textContent || '',
      tempMeterValueNow: tempMeterInitial?.getAttribute('aria-valuenow') || '',
      tempMeterLabel: tempMeterInitial?.getAttribute('aria-label') || '',
      tempMeterPending: tempMeterInitial?.dataset.pending ?? '',
      macText: macField?.textContent || '',
      beamText: beamNumberField?.textContent || '',
      rfClusterText: rfClusterField?.textContent || '',
      coords: initialCoordinatesView,
      powerStatusText: initialIndicatorTexts.power,
      coordsStatusText: initialIndicatorTexts.coords,
      gpsStatusText: initialIndicatorTexts.gps,
      inetStatusText: initialIndicatorTexts.inet,
      connectionDetails: {
        title: connectionDetailsTitle?.textContent || defaultConnectionDetails.title,
        subtitle: connectionDetailsSubtitle?.textContent || defaultConnectionDetails.subtitle
      },
      wifiPasswordView: wifiPasswordView?.textContent || '',
      wifiPasswordInput: wifiPasswordInput?.value || '',
      modemStatusText: modemStatusInitial?.textContent || '',
      cbAutoChecked: autoShutdownInitial?.checked ?? false,
      angleTexts: initialAngleTexts
    };

    const COORDS_STATUS_LABELS = {
      pending: 'Определяем…',
      ok: 'Определены',
      err: 'Ошибка'
    };
    const SIMPLE_STATUS_LABELS = {
      pending: 'Подключаем…',
      ok: 'Есть',
      err: 'Нет связи'
    };
    const INTERNET_STATUS_LABELS = {
      pending: 'Подключаем…',
      ok: 'Подключён',
      err: 'Нет соединения'
    };

    const PROGRESS_RANGE = {
      rx: { min: 0, max: 10 },   //   диапазона для RX 
      tx: { min: -5, max: 50 }    //  диапазона для TX 
    };


    function updateProgressState(indicator, rawValue, labelPrefix, range = { min: 0, max: 100 }) {
      if (!indicator?.bar) return;

      const v = Number(rawValue);
      const min = Number.isFinite(range.min) ? range.min : 0;
      const max = Number.isFinite(range.max) ? range.max : 100;
      const span = max - min;

      const norm = Number.isFinite(v) ? (v - min) : 0;               // сдвиг к 0
      const clamped = span !== 0 ? Math.min(span, Math.max(0, norm)) : 0; // клип 0..span
      const percent = Math.round((clamped / (span || 1)) * 100);     // 0..100

      if (indicator.fill) indicator.fill.style.flexGrow = String(percent);
      if (indicator.rest) indicator.rest.style.flexGrow = String(100 - percent);
      indicator.bar.setAttribute('aria-valuenow', String(percent));
      indicator.bar.setAttribute('aria-label', `${labelPrefix} ${percent}%`);
      if (indicator.value) indicator.value.textContent = `${percent}%`;
    }


    function formatCoordinate(value, fractionDigits = 2) {
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      return num.toFixed(fractionDigits);
    }

    function formatAngle(value) {
      if (value == null || value === '') return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return String(value);
      return Number.isInteger(num) ? String(num) : num.toFixed(1);
    }

    function setAngleValue(el, value) {
      if (!el) return;
      el.textContent = formatAngle(value);
    }

    function normalizeAngleForCompare(value) {
      if (value == null || value === '') return null;
      const num = Number(value);
      if (!Number.isNaN(num)) return num;
      const text = String(value).trim();
      return text === '' ? null : text;
    }

    function updateAngleMatchState(fieldEl, currentRaw, requiredRaw) {
      if (!fieldEl) return;
      const container = fieldEl.closest('[data-angle-status]');
      if (!container) return;

      const currentNormalized = normalizeAngleForCompare(currentRaw);
      const requiredNormalized = normalizeAngleForCompare(requiredRaw);
      const isMatch = currentNormalized != null &&
        requiredNormalized != null &&
        currentNormalized === requiredNormalized;

      container.classList.toggle('angle-status--match', Boolean(isMatch));
      container.classList.toggle('angle-status--mismatch', !isMatch);
    }

    function parseLogTimestamp(raw) {
      if (typeof raw !== 'string') return null;
      const m = raw.trim().match(/^(\d{2})\.(\d{2})\.(\d{4}),\s*(\d{2}):(\d{2})$/);
      if (!m) return null;
      const [, dd, mm, yyyy, hh, min] = m;
      return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
    }

    function parseLogRecord(raw, fallbackIndex) {
      const text = raw == null ? '' : String(raw);
      const parts = text.split(/\n+/);
      const firstLine = (parts.shift() || '').trim();
      const numberMatch = firstLine.match(/^(\d+)\)\s*(.*)$/);
      const number = numberMatch ? (parseInt(numberMatch[1], 10) || fallbackIndex) : fallbackIndex;
      const messageRaw = numberMatch ? numberMatch[2] : firstLine;
      const message = (messageRaw && messageRaw.trim()) || '—';
      const timestampText = (parts.pop() || '').trim();
      return { number, message, timestampText, datetime: parseLogTimestamp(timestampText) };
    }

    function renderLogs(logs) {
      if (!eventLog) return;
      eventLog.querySelectorAll('article').forEach(node => node.remove());
      const items = Array.isArray(logs) ? logs.slice(0, MAX_LOG_ENTRIES) : [];
      if (items.length === 0) {
        if (logEmptyMessage) {
          logEmptyMessage.hidden = false;
          if (!logEmptyMessage.parentElement) eventLog.appendChild(logEmptyMessage);
        }
        return;
      }
      if (logEmptyMessage) logEmptyMessage.hidden = true;

      items.forEach((raw, index) => {
        const { number, message, timestampText, datetime } = parseLogRecord(raw, index + 1);
        const article = document.createElement('article');
        article.className = index === 0 ? 'frame-24' : 'frame-25';

        const numberEl = document.createElement('div');
        numberEl.className = 'text-wrapper-17';
        numberEl.textContent = String(number);

        const messageEl = document.createElement('p');
        messageEl.className = 'div-3';
        messageEl.textContent = message;

        article.appendChild(numberEl);
        article.appendChild(messageEl);

        if (timestampText) {
          const timeEl = document.createElement('time');
          timeEl.className = 'text-wrapper-18';
          timeEl.textContent = timestampText;
          if (datetime) timeEl.setAttribute('datetime', datetime);
          article.appendChild(timeEl);
        }

        eventLog.appendChild(article);
      });
    }

    /* ===== ВЫБОР ВАРИАНТА ТЕКСТА ДЛЯ ДЕТАЛЕЙ ПОДКЛЮЧЕНИЯ ===== */
    function updateConnectionAttemptView(state = {}) {
      if (connectionDetailsSection) connectionDetailsSection.hidden = false;

      const attemptNumber = Number(state.attempt);
      let variant = defaultConnectionDetails;
      if (Number.isFinite(attemptNumber) && attemptNumber >= 0) {
        const normalizedIndex = Math.min(CONNECTION_DETAIL_VARIANTS.length - 1, Math.floor(attemptNumber));
        variant = CONNECTION_DETAIL_VARIANTS[normalizedIndex] || defaultConnectionDetails;
      }

      if (connectionDetailsTitle) connectionDetailsTitle.textContent = variant.title || defaultConnectionDetails.title;
      if (connectionDetailsSubtitle) connectionDetailsSubtitle.textContent = variant.subtitle || defaultConnectionDetails.subtitle;
    }

    function resetInterfaceToInitialState() {
      setSystemStatus('pending', initialViewState.systemBadgeText, { lock: true });

      if (typeof resetWifiThumblerToInitial === 'function') resetWifiThumblerToInitial();
      if (wifiStatusElement) wifiStatusElement.textContent = initialViewState.wifiStatusText;

      if (spanTemp) spanTemp.textContent = initialViewState.temperatureText;
      if (tempMeter) {
        tempMeter.classList.remove('meter--ok', 'meter--warn', 'meter--err');
        if (initialViewState.tempMeterValueNow) tempMeter.setAttribute('aria-valuenow', initialViewState.tempMeterValueNow);
        else tempMeter.removeAttribute('aria-valuenow');
        if (initialViewState.tempMeterLabel) tempMeter.setAttribute('aria-label', initialViewState.tempMeterLabel);
        else tempMeter.removeAttribute('aria-label');
        if (initialViewState.tempMeterPending !== undefined && initialViewState.tempMeterPending !== '') tempMeter.dataset.pending = initialViewState.tempMeterPending;
        else delete tempMeter.dataset.pending;
      }
      if (fillEl) fillEl.style.flexGrow = '';
      if (restEl) restEl.style.flexGrow = '';

      hideOverheatAdvice();
      autoShutdownSent = false;
      if (cbAuto) cbAuto.checked = initialViewState.cbAutoChecked;

      if (macField) macField.textContent = initialViewState.macText;
      if (beamNumberField) beamNumberField.textContent = initialViewState.beamText;
      if (rfClusterField) rfClusterField.textContent = initialViewState.rfClusterText;

      if (indicators.coords?.compact) indicators.coords.compact.textContent = initialViewState.coords.compact;
      if (indicators.coords?.detailed) indicators.coords.detailed.textContent = initialViewState.coords.detailed;
      if (indicators.coords?.inputs?.lat) indicators.coords.inputs.lat.value = initialViewState.coords.inputs.lat;
      if (indicators.coords?.inputs?.lng) indicators.coords.inputs.lng.value = initialViewState.coords.inputs.lng;

      setIndicatorState(indicators.power, 'pending', initialViewState.powerStatusText);
      setIndicatorState(indicators.coords, 'pending', initialViewState.coordsStatusText);
      setIndicatorState(indicators.gps, 'pending', initialViewState.gpsStatusText);
      setIndicatorState(indicators.inet, 'pending', initialViewState.inetStatusText);

      // Стартовые значения прогресса = 0%
      updateProgressState(indicators.rx, 0, 'Приём данных', PROGRESS_RANGE.rx);
      updateProgressState(indicators.tx, 0, 'Передача данных', PROGRESS_RANGE.tx);


      if (wifiPasswordView) wifiPasswordView.textContent = initialViewState.wifiPasswordView;
      if (wifiPasswordInput) wifiPasswordInput.value = initialViewState.wifiPasswordInput;

      if (typeof resetModemThumblerToInitial === 'function') resetModemThumblerToInitial();
      if (modemStatusText) modemStatusText.textContent = initialViewState.modemStatusText;

      if (angleFields.tiltCurrent) angleFields.tiltCurrent.textContent = initialViewState.angleTexts.tiltCurrent;
      if (angleFields.tiltRequired) angleFields.tiltRequired.textContent = initialViewState.angleTexts.tiltRequired;
      if (angleFields.rotateCurrent) angleFields.rotateCurrent.textContent = initialViewState.angleTexts.rotateCurrent;
      if (angleFields.rotateRequired) angleFields.rotateRequired.textContent = initialViewState.angleTexts.rotateRequired;
      updateAngleMatchState(angleFields.tiltCurrent, null, null);
      updateAngleMatchState(angleFields.rotateCurrent, null, null);

      renderLogs([]);
      updateConnectionAttemptView({ attempt: 0 });
      if (connectionDetailsTitle) connectionDetailsTitle.textContent = initialViewState.connectionDetails.title;
      if (connectionDetailsSubtitle) connectionDetailsSubtitle.textContent = initialViewState.connectionDetails.subtitle;

      setInteractiveControlsDisabled(true);
    }


    /* ===== Пороги температуры ===== */
    const TEMP_WARN = 70;   // жёлтый
    const TEMP_ERR = 85;   // красный
    const TEMP_MIN = -30;
    const TEMP_MAX = 85;

    /* ===== Обновление текста "Температура: +N℃" ===== */
    const spanTemp = document.getElementById('current-temp');
    function updateTemperatureField(tempC) {
      if (!spanTemp) return;
      const num = Number(tempC);
      if (Number.isNaN(num)) {
        spanTemp.textContent = 'Температура: —℃';
        return;
      }
      const formatted = Number.isInteger(num) ? Math.abs(num) : Math.abs(num).toFixed(1);
      const sign = num < 0 ? '−' : '+';
      spanTemp.textContent = `Температура: ${sign}${formatted}℃`;
    }

    /* ===== Полоса температуры ===== */
    const tempMeter = document.getElementById('temp-meter');
    const fillEl = tempMeter?.querySelector('.meter__fill');
    const restEl = tempMeter?.querySelector('.meter__rest');

    function clamp(v, a, b) { return Math.min(b, Math.max(a, v)); }

    function updateTempBar(tempC) {
      if (!tempMeter || !fillEl || !restEl) return;
      const p = (clamp(tempC, TEMP_MIN, TEMP_MAX) - TEMP_MIN) / (TEMP_MAX - TEMP_MIN);
      fillEl.style.flexGrow = String(p * 100);
      restEl.style.flexGrow = String((1 - p) * 100);

      tempMeter.classList.remove('meter--ok', 'meter--warn', 'meter--err');
      if (tempC >= TEMP_ERR) tempMeter.classList.add('meter--err');
      else if (tempC >= TEMP_WARN) tempMeter.classList.add('meter--warn');
      else tempMeter.classList.add('meter--ok');

      tempMeter.setAttribute('aria-valuenow', String(Math.round(tempC)));
      tempMeter.setAttribute('aria-label', `Температура модема ${Math.round(tempC)} градусов`);
      tempMeter.removeAttribute('data-pending');
    }

    /* ===== Подсказки и статус по температуре ===== */
    const tempAlert = document.getElementById('temp-alert');
    const tempAlertText = document.getElementById('temp-alert-text');
    const modemStatusText = document.getElementById('modem-power-status');
    const modemThumbler = document.querySelector('[data-thumbler="modem"]');
    const modemPowerRadios = modemThumbler
      ? Array.from(modemThumbler.querySelectorAll('input[name="modem-power-toggle"]'))
      : [];
    const cbAuto = document.getElementById('auto-shutdown-hot');
    let updateModemThumbler = null;
    let setModemThumblerDisabled = null;
    let resetModemThumblerToInitial = null;

    function showOverheatAdvice(level, tempC) {
      if (!tempAlert) return;
      tempAlertText.textContent = (level === 'err')
        ? 'Опасная температура! Немедленно выключите модем или переместите его в прохладное место.'
        : 'Рекомендуется выключить модем на время или укрыть / перенести его от прямых солнечных лучей';
      tempAlert.hidden = false;
      tempAlert.setAttribute('aria-label', `Предупреждение о перегреве: ${Math.round(tempC)}℃`);
    }
    function hideOverheatAdvice() { if (tempAlert) tempAlert.hidden = true; }

    (function initModemThumbler() {
      if (!modemThumbler) return;

      const initialThumblerClassName = modemThumbler.className;
      const initialRadiosChecked = modemPowerRadios.map(radio => radio.checked);
      const initialRadiosDisabled = modemPowerRadios.map(radio => radio.disabled);
      const initialThumblerAriaDisabled = modemThumbler.getAttribute('aria-disabled');
      const initialStatusText = modemStatusText?.textContent || '';

      resetModemThumblerToInitial = function () {
        modemThumbler.className = initialThumblerClassName;
        if (initialThumblerAriaDisabled != null) modemThumbler.setAttribute('aria-disabled', initialThumblerAriaDisabled);
        else modemThumbler.removeAttribute('aria-disabled');
        modemPowerRadios.forEach((radio, index) => {
          radio.checked = Boolean(initialRadiosChecked[index]);
          radio.disabled = Boolean(initialRadiosDisabled[index]);
        });
        if (modemStatusText) modemStatusText.textContent = initialStatusText;
      };

      function applyState(value) {
        const normalized = value === 'on' ? 'on' : 'off';
        modemThumbler.classList.toggle('thumbler--on', normalized === 'on');
        modemThumbler.classList.toggle('thumbler--off', normalized === 'off');
        modemPowerRadios.forEach(radio => { radio.checked = radio.value === normalized; });
      }

      function setDisabled(disabled) {
        modemPowerRadios.forEach(radio => { radio.disabled = disabled; });
        modemThumbler.classList.toggle('thumbler--disabled', disabled);
        if (disabled) modemThumbler.setAttribute('aria-disabled', 'true');
        else modemThumbler.removeAttribute('aria-disabled');
      }

      function currentState() {
        return modemThumbler.classList.contains('thumbler--on') ? 'on' : 'off';
      }

      updateModemThumbler = applyState;
      setModemThumblerDisabled = setDisabled;

      modemPowerRadios.forEach(radio => {
        radio.addEventListener('change', async (event) => {
          const requested = event.target.value === 'on' ? 'on' : 'off';
          const previous = currentState();
          if (requested === previous) return;

          // setDisabled(true);
          // if (modemStatusText) {
          //   modemStatusText.textContent = requested === 'on' ? 'Включаем…' : 'Выключаем…';
          // }

          applyState(requested);

          try {
            await sendLocalGet(API_MODEM_POWER_ENDPOINT, { state: requested });
            updatePowerControls(requested === 'on');
          } catch (e) {
            console.error('Не удалось переключить питание модема', e);
            updatePowerControls(previous === 'on');
          }
        });
      });
    })();

    function updatePowerControls(powerOn) {
      const isOn = powerOn === true;
      if (setModemThumblerDisabled) setModemThumblerDisabled(false);
      if (updateModemThumbler) updateModemThumbler(isOn ? 'on' : 'off');
      //   if (modemStatusText) modemStatusText.textContent = isOn ? 'Модем включен' : 'Модем выключен';
    }

    let autoShutdownSent = false;


    cbAuto?.addEventListener('change', async (event) => {
      const enabled = event.target.checked;
      try {
        cbAuto.disabled = true;
        await sendLocalGet(API_MODEM_AUTO_SHUTDOWN_ENDPOINT, { state: enabled ? 'on' : 'off' });
      } catch (e) {
        console.error('Не удалось изменить настройку автотушения модема', e);
      } finally {
        cbAuto.disabled = false;
      }
    });

    function applyStatusByTemperature(tempC, { allowBadgeUpdate = true } = {}) {
      if (tempC == null || isNaN(tempC)) return;

      if (allowBadgeUpdate && !systemStatusLocked) {
        if (tempC >= TEMP_ERR) setSystemStatus('err');
        else if (tempC >= TEMP_WARN) setSystemStatus('warn');
        else setSystemStatus('ok');
      }

      if (tempC >= TEMP_ERR) showOverheatAdvice('err', tempC);
      else if (tempC >= TEMP_WARN) showOverheatAdvice('warn', tempC);
      else {
        hideOverheatAdvice();
        autoShutdownSent = false;
      }

      if (cbAuto?.checked && tempC >= TEMP_ERR && !autoShutdownSent) {
        autoShutdownSent = true;
        shutdownModemSafely(true);
      }
    }

    /* ===== Инициализация из DOM-метра при загрузке ===== */
    (function initTempFromDOM() {
      const meter = document.querySelector('[role="meter"][aria-label*="Температура модема"]');
      if (!meter) return;
      if (meter.dataset.pending === 'true') return;
      const raw = meter.getAttribute('aria-valuenow');
      if (!raw) return;
      const now = parseFloat(raw);
      if (!Number.isNaN(now)) {
        updateTemperatureField(now);
        applyStatusByTemperature(now, { allowBadgeUpdate: !systemStatusLocked });
        updateTempBar(now);
      }
    })();

    /* ===== Точка входа новых данных от устройства ===== */
    window.onDeviceState = function (state) {
      if (!state) return;

      setInteractiveControlsDisabled(false);
      systemStatusLocked = false;

      if (typeof state.mac === 'string' && macField) {
        macField.textContent = `MAC-адрес: ${state.mac}`;
      }

      if ('beam_number' in state && beamNumberField) {
        const beamValue = state.beam_number;
        beamNumberField.textContent = (beamValue == null || beamValue === '') ? '—' : String(beamValue);
      }

      if ('rf_cluster_polarization' in state && rfClusterField) {
        const clusterValue = state.rf_cluster_polarization;
        const formattedCluster = (clusterValue == null || clusterValue === '') ? '—' : String(clusterValue);
        rfClusterField.textContent = formattedCluster;
      }

      if ('power' in state) {
        const powerStatus = state.power === true ? 'ok' : (state.power === false ? 'off' : 'pending');
        const powerText = state.power === true ? 'Есть' : (state.power === false ? 'Нет' : 'Ожидание…');
        setIndicatorState(indicators.power, powerStatus, powerText);
        updatePowerControls(state.power === true);
      }

      if ('wifi_on' in state && typeof updateWifiThumbler === 'function') {
        updateWifiThumbler(state.wifi_on ? 'on' : 'off');
      }

      if ('modem_off_temp' in state && cbAuto) {
        cbAuto.checked = state.modem_off_temp === true;
      }

      const coords = state.coords || {};
      const coordsEditing = isRowEditing(rows.coords);
      if (indicators.coords && !coordsEditing) {
        const formattedLat = (coords.lat != null && coords.lat !== '') ? formatCoordinate(coords.lat) : '—';
        const formattedLng = (coords.lng != null && coords.lng !== '') ? formatCoordinate(coords.lng) : '—';
        if (indicators.coords.compact) indicators.coords.compact.textContent = `Ш: ${formattedLat}; Д: ${formattedLng}`;
        if (indicators.coords.detailed) indicators.coords.detailed.textContent = ` Широта: ${formattedLat}; Долгота: ${formattedLng}`;
        if (indicators.coords.inputs?.lat) indicators.coords.inputs.lat.value = (coords.lat != null && coords.lat !== '') ? String(coords.lat) : '';
        if (indicators.coords.inputs?.lng) indicators.coords.inputs.lng.value = (coords.lng != null && coords.lng !== '') ? String(coords.lng) : '';
      }

      if ('wifi_password' in state && !isRowEditing(rows.wifiPass)) {
        const rawPass = state.wifi_password;
        const passwordText = rawPass == null ? '' : String(rawPass);
        if (wifiPasswordView) wifiPasswordView.textContent = passwordText;
        if (wifiPasswordInput) wifiPasswordInput.value = passwordText;
      }

      if ('coords_status' in state && indicators.coords) {
        const status = ['pending', 'ok', 'err'].includes(state.coords_status) ? state.coords_status : 'pending';
        setIndicatorState(indicators.coords, status, COORDS_STATUS_LABELS[status] || COORDS_STATUS_LABELS.pending);
      }

      if ('gps_status' in state) {
        const status = ['pending', 'ok', 'err'].includes(state.gps_status) ? state.gps_status : 'pending';
        setIndicatorState(indicators.gps, status, SIMPLE_STATUS_LABELS[status] || SIMPLE_STATUS_LABELS.pending);
      }

      if ('inet_status' in state) {
        const status = ['pending', 'ok', 'err'].includes(state.inet_status) ? state.inet_status : 'pending';
        setIndicatorState(indicators.inet, status, INTERNET_STATUS_LABELS[status] || INTERNET_STATUS_LABELS.pending);
      }

      if (state.rx) updateProgressState(indicators.rx, state.rx.progress, 'Приём данных', PROGRESS_RANGE.rx);
      if (state.tx) updateProgressState(indicators.tx, state.tx.progress, 'Передача данных', PROGRESS_RANGE.tx);


      if (state.angles) {
        const tiltCurrentRaw = state.angles.tilt_current;
        const tiltRequiredRaw = state.angles.tilt_required;
        const rotateCurrentRaw = state.angles.rotate_current;
        const rotateRequiredRaw = state.angles.rotate_required;

        setAngleValue(angleFields.tiltCurrent, tiltCurrentRaw);
        setAngleValue(angleFields.tiltRequired, tiltRequiredRaw);
        setAngleValue(angleFields.rotateCurrent, rotateCurrentRaw);
        setAngleValue(angleFields.rotateRequired, rotateRequiredRaw);

        updateAngleMatchState(angleFields.tiltCurrent, tiltCurrentRaw, tiltRequiredRaw);
        updateAngleMatchState(angleFields.rotateCurrent, rotateCurrentRaw, rotateRequiredRaw);
      }

      if ('logs' in state) renderLogs(state.logs);

      // Обновляем текст "Детали подключения" в зависимости от attempt
      updateConnectionAttemptView(state);

      if ('system' in state) {
        const knownStates = ['pending', 'ok', 'warn', 'err', 'off'];
        const normalized = knownStates.includes(state.system) ? state.system : 'pending';
        setSystemStatus(normalized, undefined, { lock: true });
      }

      if (state.modem_off) {
        setSystemStatus('off', 'Модем отключен', { lock: true });
      }

      if (state.temp_c != null) {
        const t = Number(state.temp_c);
        if (!Number.isNaN(t)) {
          updateTemperatureField(t);
          updateTempBar(t);
          applyStatusByTemperature(t, { allowBadgeUpdate: !systemStatusLocked });
        }
      }
    };

    const wifiControlsSection = document.querySelector('.frame-3');
    const modemControlsSection = document.querySelector('.temp-alert__actions.modem-controls__row');

    function toggleSectionDisabled(section, disabled) {
      if (!section) return;
      section.classList.toggle('is-disabled', disabled);
      if (disabled) section.setAttribute('aria-disabled', 'true');
      else section.removeAttribute('aria-disabled');
    }

    function setInteractiveControlsDisabled(disabled) {
      toggleSectionDisabled(wifiControlsSection, disabled);
      toggleSectionDisabled(modemControlsSection, disabled);

      if (typeof setWifiThumblerDisabled === 'function') setWifiThumblerDisabled(disabled);
      if (typeof setModemThumblerDisabled === 'function') setModemThumblerDisabled(disabled);

      if (cbAuto) cbAuto.disabled = disabled;

      modemControlsSection?.querySelectorAll('button').forEach(btn => { btn.disabled = disabled; });
    }

    setInteractiveControlsDisabled(true);

    /* ===== Пуллинг состояния с демо-сервером ===== */
    const API_STATE_URL = "/api/state";

    async function pollDeviceState() {
      try {
        const r = await fetch(API_STATE_URL, { cache: "no-store" });
        if (!r.ok) {
          resetInterfaceToInitialState();
          return;
        }
        const data = await r.json();
        if (!data || typeof data !== 'object') {
          resetInterfaceToInitialState();
          return;
        }
        window.onDeviceState?.(data);
      } catch (e) {
        resetInterfaceToInitialState();
      }
    }
    pollDeviceState();
    restartStatePollingTimer();
  </script>



  <!-- SVG SPRITE -->
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="0" height="0"
    style="position:absolute;left:-9999px;">
    <defs>
      <symbol id="icon-status-ok" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="currentColor" />
        <path d="M6 12L10 16.5L18.5 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"
          stroke-linejoin="round" />
      </symbol>

      <symbol id="icon-status-err" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="currentColor" />
        <path d="M7 17.4497L17.4497 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" />
        <path d="M17.4497 17.4497L7 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" />
      </symbol>

      <symbol id="icon-status-off" viewBox="0 0 28 28">
        <circle cx="14" cy="14" r="13" fill="currentColor" stroke="#fff" stroke-width="2" />
        <path d="M8 14L12 18.5L20.5 9" stroke="#8C8C8C" stroke-width="2" fill="none" stroke-linecap="round"
          stroke-linejoin="round" />
      </symbol>
    </defs>
  </svg>

</body>

</html>