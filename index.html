<!DOCTYPE html>
<html lang="ru">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <title>ТКС «ОРИОН» - Панель управления</title>
  <link rel="stylesheet" href="globals.css" />
  <link rel="stylesheet" href="styleguide.css" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="screen">
    <header class="frame">
      <div class="div">
        <h1 class="text-wrapper">ТКС «ОРИОН»</h1>
      </div>
      <div id="system-badge" class="badge badge--ok" role="status" aria-label="Статус системы: Всё работает">
        <div class="ellipse" aria-hidden="true"></div>
        <span class="text-wrapper-2">Всё работает</span>
      </div>

      <div class="frame-2">
        <p class=" value-view ">
          <span id="current-temp" class="span">Температура: +45℃</span>
        </p>

        <div class="div-2">MAC-адрес: 12.34.56.78</div>
      </div>
      <div class="frame-3">
        <div class="wi-fi" id="wifi-status-text">WiFi Работает</div>

        <fieldset class="thumbler thumbler--on" role="radiogroup" aria-labelledby="wifi-status">
          <legend id="wifi-status" class="sr-only">Статус WiFi</legend>

          <!-- подложка-ползунок -->
          <div class="thumbler__knob" aria-hidden="true"></div>

          <label class="thumbler__option thumbler__option--left">
            <input type="radio" name="wifi-toggle" value="off" class="sr-only" />
            <span>Выкл</span>
          </label>

          <label class="thumbler__option thumbler__option--right">
            <input type="radio" name="wifi-toggle" value="on" checked class="sr-only" />
            <span>Вкл</span>
          </label>
        </fieldset>
      </div>

    </header>

    <div class="frame-wrapper">
      <div class="frame-4">
        <section class="frame-5" aria-label="Статус системы">
          <article class="frame-6">
            <svg class="status-icon status-icon--ok" role="img" aria-label="ОК">
              <use href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Питание</h3>
              <div class="text-wrapper-4">Есть</div>
            </div>
          </article>
          <article class="frame-9">
            <svg class="status-icon status-icon--ok" role="img" aria-label="ОК">
              <use href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Координаты</h3>
              <p class="element">
                <span id="coords-compact" class="text-wrapper-5">Ш: 55.73; Д: 55.73 </span>
                <br> <span class="text-wrapper-6">Определены</span>
              </p>

            </div>
          </article>

          <article class="frame-9">
            <svg class="status-icon status-icon--ok" role="img" aria-label="ОК">
              <use href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Связь<br />со спутником</h3>
              <div class="text-wrapper-4">Есть</div>
            </div>
          </article>

          <article class="frame-9">
            <svg class="status-icon status-icon--ok" role="img" aria-label="ОК">
              <use href="#icon-status-ok"></use>
            </svg>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Интернет</h3>
              <div class="text-wrapper-4">Есть</div>
            </div>
          </article>

          <article class="frame-10">
            <div class="frame-11" role="progressbar" aria-valuenow="98" aria-valuemin="0" aria-valuemax="100"
              aria-label="Приём данных 98%">
              <div class="rectangle"></div>
              <div class="rectangle-2"></div>
            </div>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Приём данных</h3>
              <p class="p"><span class="text-wrapper-7">98% (-10 из 6,6Дб) </span><span
                  class="text-wrapper-8">Нормально</span></p>
            </div>
          </article>

          <article class="frame-12">
            <div class="frame-11" role="progressbar" aria-valuenow="98" aria-valuemin="0" aria-valuemax="100"
              aria-label="Передача данных 98%">
              <div class="rectangle"></div>
              <div class="rectangle-2"></div>
            </div>
            <div class="frame-7">
              <h3 class="text-wrapper-3">Передача данных</h3>
              <p class="p"><span class="text-wrapper-7">98% (-10 из 6,6Дб) </span><span
                  class="text-wrapper-8">Нормально</span></p>
            </div>
          </article>
        </section>

        <section class="frame-13" aria-label="Детали подключения и управление">
          <div class="frame-14">

            <section class="frame-15">
              <h2 class="text-wrapper-9">Детали подключения</h2>

              <div class="frame-16">

                <div class="frame-17" id="row-coords">
                  <div class="div-wrapper">
                    <label class="text-wrapper-10" for="lat">Координаты</label>
                  </div>

                  <!-- Просмотр -->
                  <p class="span-wrapper value-view">
                    <span class="span"> Широта: 55.73; Долгота: 37.61</span>
                  </p>

                  <!-- Чекбокс -->
                  <div class="checkbox-w-label">
                    <input type="checkbox" id="edit-coordinates" class="checkbox-input sr-only" />
                    <label for="edit-coordinates" class="checkbox">
                      <div class="rectangle-3"></div>
                    </label>
                    <label for="edit-coordinates" class="label"><span class="title-3">Изменить</span></label>
                  </div>

                  <form class="edit-area" aria-label="Редактирование координат">
                    <div class="input-group">
                      <label for="lat">Широта</label>
                      <input id="lat" name="lat" type="text" inputmode="decimal" class="input" value="55.73">
                    </div>

                    <span class="input-dash" aria-hidden="true">—</span>

                    <div class="input-group">
                      <label for="lng">Долгота</label>
                      <input id="lng" name="lng" type="text" inputmode="decimal" class="input" value="37.61">
                    </div>

                    <span class="spacer" aria-hidden="true"></span>
                    <button class="btn btn-primary btn-save" type="submit">Сохранить</button>
                    <button class="btn btn-secondary btn-cancel" type="button">Отменить</button>
                  </form>

                </div>


                <div class="separator" aria-hidden="true"></div>

                <!-- ===== Пароль Wi-Fi (редактирование по чекбоксу) ===== -->
                <div class="frame-17" id="row-wifi-pass">
                  <div class="div-wrapper">
                    <label class="text-wrapper-10" for="wifi-pass">Пароль на WiFi</label>
                  </div>

                  <!-- Просмотр -->
                  <p class="span-wrapper value-view">
                    <span class="span">12345678</span>
                  </p>

                  <!-- Переключатель -->
                  <div class="checkbox-w-label">
                    <input type="checkbox" id="edit-wifi-password" class="checkbox-input sr-only" />
                    <label for="edit-wifi-password" class="checkbox">
                      <div class="rectangle-3"></div>
                    </label>
                    <label for="edit-wifi-password" class="label"><span class="title-3">Изменить</span></label>
                  </div>

                  <!-- Редактор -->
                  <form class="edit-area" aria-label="Редактирование пароля Wi-Fi">
                    <input id="wifi-pass" name="wifi-pass" type="password" minlength="8" class="input"
                      placeholder="Введите новый пароль" value="12345678" aria-describedby="wifi-hint"
                      aria-label="Пароль Wi-Fi">
                    <span id="wifi-hint" class="hint">Минимум 8 символов</span>

                    <button class="btn btn-primary btn-save" type="submit">Сохранить</button>
                    <button class="btn btn-secondary btn-cancel" type="button">Отменить</button>
                  </form>
                </div>

                <!-- Остальные строки как были -->
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-17">
                  <div class="div-wrapper">
                    <p class="div-3">Номер луча в радио-частотном (РЧ) кластере</p>
                  </div>
                  <p class="span-wrapper"><span class="span">34</span></p>
                </div>
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-18">
                  <div class="div-wrapper">
                    <div class="text-wrapper-11">РЧ кластер / поляризация</div>
                  </div>
                  <p class="element-2"><span class="span">31 / А</span></p>
                </div>
                <div class="separator" aria-hidden="true"></div>
                <div class="frame-19">
                  <div class="frame-20">
                    <div class="frame-21">
                      <div class="div-3">Температура модема</div>
                    </div>
                    <div class="state-default">
                      <div class="frame-11 meter" id="temp-meter" role="meter" aria-valuenow="45" aria-valuemin="-30"
                        aria-valuemax="85" aria-label="Температура модема 45 градусов">
                        <div class="rectangle rectangle-4 meter__fill"></div>
                        <div class="rectangle-2 meter__rest"></div>
                      </div>
                      <div class="frame-22">
                        <div class="text-wrapper-12">Низкая (-30℃)</div>
                        <div class="text-wrapper-13">Нормальная (+10℃)</div>
                        <div class="text-wrapper-14">Высокая (85℃)</div>
                      </div>
                    </div>
                  </div>
                  <!-- Блок рекомендаций при перегреве -->
                  <div id="temp-alert" class="temp-alert" role="region" aria-live="polite" hidden>
                    <div class="temp-alert__row">
                      <!-- маленькая иконка-warning -->
                      <svg class="temp-alert__icon" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 2 1 21h22L12 2Zm1 14h-2v2h2v-2Zm0-8h-2v6h2V8Z" fill="currentColor" />
                      </svg>
                      <p id="temp-alert-text" class="temp-alert__text">
                        Рекомендуется выключить модем на время или укрыть / перенести его от прямых солнечных лучей
                      </p>
                    </div>

                    <div class="temp-alert__actions">
                      <button id="btn-shutdown-modem" type="button" class="btn btn-primary temp-alert__btn">
                        Выключить модем
                      </button>

                      <label class="temp-alert__auto">
                        <input id="auto-shutdown-hot" type="checkbox" class="temp-alert__checkbox" checked />
                        Выключать автоматически при опасных температурах
                      </label>
                    </div>
                  </div>

                </div>

              </div>
            </section>

            <section class="frame-15">
              <div class="frame-7">
                <h2 class="text-wrapper-15">Лог событий</h2>
                <p class="text-wrapper-16">Показано максимум 10 последних событий</p>
              </div>

              <div class="frame-23" role="log" aria-label="События системы">
                <article class="frame-24">
                  <div class="text-wrapper-17">1</div>
                  <p class="div-3">Автовыключение — Сработало из-за повышенной температуры</p>
                  <time class="text-wrapper-18" datetime="2025-09-25T12:41">25.09.2025, 12:41</time>
                </article>

                <article class="frame-25">
                  <div class="text-wrapper-17">2</div>
                  <p class="div-3"><span class="span">Температура модема — Высокая: 85℃, Выше нормальной на 56℃</span>
                  </p>
                  <time class="text-wrapper-18" datetime="2025-09-25T12:34">25.09.2025, 12:34</time>
                </article>

                <article class="frame-25">
                  <div class="text-wrapper-17">3</div>
                  <p class="div-3"><span class="span">Температура модема — Высокая: 85℃, Выше нормальной на 56℃</span>
                  </p>
                  <time class="text-wrapper-18" datetime="2025-09-25T12:34">25.09.2025, 12:34</time>
                </article>

                <article class="frame-25">
                  <div class="text-wrapper-17">4</div>
                  <p class="div-3"><span class="span">Температура модема — Высокая: 85℃, Выше нормальной на 56℃</span>
                  </p>
                  <time class="text-wrapper-18" datetime="2025-09-25T12:34">25.09.2025, 12:34</time>
                </article>
              </div>
            </section>
          </div>

          <aside class="frame-26" aria-label="Углы наклона и поворота">
            <div class="frame-7">
              <h3 class="text-wrapper-19">Угол наклона (Азимута)</h3>
              <div class="frame-27">
                <!-- SVG как у вас -->
                <svg width="66" height="66" viewBox="0 0 66 66" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M49.1798 59.9657L37.8045 51.3335" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="2.2895" cy="2.2895" r="1.7895"
                    transform="matrix(-0.965926 0.258819 0.258819 0.965926 52.5015 58.3749)" stroke="#8C8C8C" />
                  <path d="M24.4533 59.8131L35.6758 51.3335" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="22.9032" cy="61.1789" r="1.7895" transform="rotate(15 22.9032 61.1789)"
                    stroke="#8C8C8C" />
                  <path d="M32.2376 59.2025L36.8166 51.2656" stroke="#8C8C8C" stroke-linecap="round" />
                  <circle cx="31.4506" cy="61.179" r="1.7895" transform="rotate(15 31.4506 61.179)" stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="9.68431" height="8.46325" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 35.6069 39.9205)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="19.1476" height="6.63165" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 35.4082 31.9626)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="26.9988" height="7.54745" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 31.4568 25.6283)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="2.35793" height="10.2948" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 38.8046 20.6906)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="6.93692" height="7.92708" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 50.3597 14.3517)" fill="white"
                    stroke="#8C8C8C" />
                  <rect x="-0.136116" y="0.693882" width="5.43112" height="5.41059" rx="0.721064"
                    transform="matrix(-0.829998 0.557766 0.557766 0.829998 44.9997 19.4697)" fill="white"
                    stroke="#8C8C8C" />
                  <path
                    d="M28.3346 9.51855C27.9145 9.99881 27.6462 10.7467 27.5775 11.7922C27.4907 13.1151 27.732 14.8213 28.2943 16.8051C29.4174 20.7673 31.7892 25.7281 35.1532 30.7341C38.5172 35.7399 42.214 39.8095 45.4581 42.3462C47.0825 43.6164 48.5711 44.4843 49.8288 44.9037C50.8227 45.2352 51.616 45.2683 52.2194 45.061C45.8813 35.6295 34.9843 19.4137 28.3346 9.51855Z"
                    fill="white" stroke="#8C8C8C" />
                  <line x1="0.5" y1="-0.5" x2="49.5636" y2="-0.5" transform="matrix(-1 0 0 1 62.3063 63.7815)"
                    stroke="#8C8C8C" stroke-linecap="round" />
                </svg>
                <div class="frame-28">
                  <div class="text-wrapper-20">Текущий — 123</div>
                  <div class="text-wrapper-21">Требуемый — 456</div>
                </div>
              </div>
            </div>

            <div class="frame-7">
              <h3 class="text-wrapper-19">Угол поворота</h3>
              <div class="frame-27">
                <div class="group-2">
                  <svg class="group-3" width="80" height="80" viewBox="0 0 56 56" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <rect x="-0.114869" y="0.585741" width="22.7168" height="13.6593" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 25.1881 21.1409)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="1.99005" height="8.75687" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 32.4403 18.6254)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="5.84168" height="6.74621" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 42.083 13.2011)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <rect x="-0.114869" y="0.585741" width="4.57507" height="4.60925" rx="0.601718"
                      transform="matrix(-0.82342 0.567433 0.548114 0.836403 37.6101 17.5807)" fill="white"
                      stroke="#8C8C8C" stroke-width="0.834486" />
                    <path
                      d="M23.7014 9.06117C23.3494 9.47216 23.1239 10.1135 23.0664 11.0116C22.9939 12.1449 23.1956 13.6056 23.665 15.3039C24.6025 18.6957 26.5821 22.9419 29.3899 27.2265C32.1977 31.511 35.2837 34.9947 37.992 37.1664C39.348 38.2536 40.5907 38.9969 41.6413 39.3562C42.4738 39.6409 43.1377 39.6682 43.6417 39.4894C38.3519 31.4174 29.2516 17.5305 23.7014 9.06117Z"
                      fill="white" stroke="#8C8C8C" stroke-width="0.834486" />
                  </svg>
                  <div class="text-wrapper-22" aria-label="Север">N</div>
                  <div class="text-wrapper-23" aria-label="Юг">S</div>
                  <div class="text-wrapper-24" aria-label="Запад">W</div>
                  <div class="text-wrapper-25" aria-label="Восток">E</div>
                </div>
                <div class="frame-28">
                  <p class="element-3"><span class="text-wrapper-26">Текущий — 1860</span></p>
                  <div class="text-wrapper-21">Требуемый — 1860</div>
                </div>
              </div>
            </div>
          </aside>
        </section>

        <footer class="footer">
          <div class="frame-29">
            <div class="text-wrapper-27">Версия ПО: 1.1</div>
            <button type="button" class="button-2">
              <span class="title-4">Обновить до 1.2</span>
            </button>
          </div>
          <div class="button-wrapper">
            <button type="button" class="button-2">
              <span class="title-4">Перенастроить модем</span>
            </button>
          </div>
        </footer>
      </div>
    </div>
  </main>

  <!-- Скрипт переключения режима редактирования -->
  <script>
    /* ===== Режим редактирования/просмотра по чекбоксам ===== */
    document.querySelectorAll('.checkbox-input').forEach(cb => {
      cb.addEventListener('change', e => {
        const row = e.target.closest('.frame-17');
        if (!row) return;
        row.classList.toggle('editing', e.target.checked);
        if (e.target.checked) {
          const firstInput = row.querySelector('.edit-area .input');
          if (firstInput) firstInput.focus();
        }
      });
    });

    document.querySelectorAll('.frame-17 .btn-cancel').forEach(btn => {
      btn.addEventListener('click', e => {
        const row = e.target.closest('.frame-17');
        const cb = row.querySelector('.checkbox-input');
        if (cb) { cb.checked = false; row.classList.remove('editing'); }
      });
    });

    document.querySelectorAll('.frame-17 form.edit-area').forEach(form => {
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const row = form.closest('.frame-17');

        if (row.id === 'row-coords') {
          const lat = form.querySelector('[name="lat"]').value.trim();
          const lng = form.querySelector('[name="lng"]').value.trim();
          row.querySelector('.value-view .span').textContent = `Широта: ${lat}; Долгота: ${lng}`;
          // await fetch('/api/coords', { ... });
          // Обновить компактный вывод в верхней карточке "Координаты"
          const compact = document.getElementById('coords-compact');
          if (compact) {
            compact.textContent = `Ш: ${lat}; Д: ${lng}`;
          }

        }

        if (row.id === 'row-wifi-pass') {
          const pass = form.querySelector('[name="wifi-pass"]').value;
          row.querySelector('.value-view .span').textContent = pass;
          // await fetch('/api/wifi', { ... });
        }

        const cb = row.querySelector('.checkbox-input');
        if (cb) { cb.checked = false; row.classList.remove('editing'); }
      });
    });

    /* ===== Тумблер Wi-Fi ===== */
    (function () {
      const thumbler = document.querySelector('.thumbler');
      if (!thumbler) return;

      const radios = thumbler.querySelectorAll('input[name="wifi-toggle"]');
      const statusText = document.getElementById('wifi-status-text');

      function applyState(value) {
        thumbler.classList.toggle('thumbler--on', value === 'on');
        thumbler.classList.toggle('thumbler--off', value === 'off');
        if (statusText) statusText.textContent = (value === 'on') ? 'WiFi Работает' : 'WiFi Выключен';
      }

      const checked = Array.from(radios).find(r => r.checked);
      applyState(checked ? checked.value : 'off');

      radios.forEach(r => {
        r.addEventListener('change', (e) => {
          const v = e.target.value === 'on' ? 'on' : 'off';
          applyState(v);
          // fetch('/api/wifi', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ wifi_on: v === 'on' }) }).catch(console.error);
        });
      });
    })();

    /* ===== Статус системы (бейдж) ===== */
    const systemBadge = document.getElementById('system-badge');
    function setSystemStatus(kind, textOverride) {
      if (!systemBadge) return;
      const textMap = { ok: 'Всё работает', warn: 'Есть проблемы', err: 'Есть проблемы', off: 'Модем отключен' };
      systemBadge.classList.remove('badge--ok', 'badge--warn', 'badge--err', 'badge--off');
      systemBadge.classList.add(`badge--${kind}`);
      const text = textOverride || textMap[kind] || '';
      const span = systemBadge.querySelector('.text-wrapper-2');
      if (span) span.textContent = text;
      systemBadge.setAttribute('aria-label', `Статус системы: ${text}`);
    }

    /* ===== Пороги температуры ===== */
    const TEMP_WARN = 70;   // жёлтый
    const TEMP_ERR = 85;   // красный
    const TEMP_MIN = -30;  // как в подписи
    const TEMP_MAX = 85;

    /* ===== Обновление текста "Температура: +N℃" ===== */
    const spanTemp = document.getElementById('current-temp');
    function updateTemperatureField(tempC) {
      if (!spanTemp) return;
      spanTemp.textContent = `Температура: +${tempC}℃`;
    }

    /* ===== Полоса температуры (процент + цвет) ===== */
    const tempMeter = document.getElementById('temp-meter');
    const fillEl = tempMeter?.querySelector('.meter__fill');
    const restEl = tempMeter?.querySelector('.meter__rest');

    function clamp(v, a, b) { return Math.min(b, Math.max(a, v)); }

    function updateTempBar(tempC) {
      if (!tempMeter || !fillEl || !restEl) return;

      // ограничиваем только визуальное заполнение
      const p = (clamp(tempC, TEMP_MIN, TEMP_MAX) - TEMP_MIN) / (TEMP_MAX - TEMP_MIN);
      fillEl.style.flexGrow = String(p * 100);
      restEl.style.flexGrow = String((1 - p) * 100);

      tempMeter.classList.remove('meter--ok', 'meter--warn', 'meter--err');
      if (tempC >= TEMP_ERR) tempMeter.classList.add('meter--err');
      else if (tempC >= TEMP_WARN) tempMeter.classList.add('meter--warn');
      else tempMeter.classList.add('meter--ok');

      // aria — показываем реальную температуру
      tempMeter.setAttribute('aria-valuenow', String(Math.round(tempC)));
      tempMeter.setAttribute('aria-label', `Температура модема ${Math.round(tempC)} градусов`);
    }

    /* ===== Подсказки и статус по температуре ===== */
    const tempAlert = document.getElementById('temp-alert');
    const tempAlertText = document.getElementById('temp-alert-text');
    const btnShutdown = document.getElementById('btn-shutdown-modem');
    const cbAuto = document.getElementById('auto-shutdown-hot');

    function showOverheatAdvice(level, tempC) {
      if (!tempAlert) return;
      tempAlertText.textContent = (level === 'err')
        ? 'Опасная температура! Немедленно выключите модем или переместите его в прохладное место.'
        : 'Рекомендуется выключить модем на время или укрыть / перенести его от прямых солнечных лучей';
      tempAlert.hidden = false;
      tempAlert.setAttribute('aria-label', `Предупреждение о перегреве: ${Math.round(tempC)}℃`);
    }
    function hideOverheatAdvice() { if (tempAlert) tempAlert.hidden = true; }

    // флаг, чтобы авто-выключение отправлялось один раз на «красной» зоне
    let autoShutdownSent = false;

    async function shutdownModemSafely(isAuto = false) {
      try {
        // await fetch('/api/modem/power', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ on:false }) });
        setSystemStatus('off', 'Модем отключен');            // мгновенно в UI
        // НЕ скрываем предупреждение здесь — пусть пользователь видит причину
        if (btnShutdown) {
          btnShutdown.disabled = true;
          btnShutdown.textContent = isAuto ? 'Выключаем...' : 'Выключаем...';
        }
      } catch (e) {
        console.error('Не удалось выключить модем:', e);
        autoShutdownSent = false;
        if (btnShutdown) {
          btnShutdown.disabled = false;
          btnShutdown.textContent = 'Выключить модем';
        }
      }
    }
    btnShutdown?.addEventListener('click', () => shutdownModemSafely(false));

    function applyStatusByTemperature(tempC) {
      if (tempC == null || isNaN(tempC)) return;

      if (tempC >= TEMP_ERR) setSystemStatus('err');
      else if (tempC >= TEMP_WARN) setSystemStatus('warn');
      else setSystemStatus('ok');

      if (tempC >= TEMP_ERR) showOverheatAdvice('err', tempC);
      else if (tempC >= TEMP_WARN) showOverheatAdvice('warn', tempC);
      else {
        hideOverheatAdvice();
        autoShutdownSent = false; // сброс, когда вернулись в норму
      }

      // авто-отключение: только один раз и не скрываем предупреждение
      if (cbAuto?.checked && tempC >= TEMP_ERR && !autoShutdownSent) {
        autoShutdownSent = true;
        shutdownModemSafely(true);
      }
    }

    /* ===== Инициализация из DOM-метра при загрузке ===== */
    (function initTempFromDOM() {
      const meter = document.querySelector('[role="meter"][aria-label*="Температура модема"]');
      if (!meter) return;
      const now = parseFloat(meter.getAttribute('aria-valuenow'));
      if (!isNaN(now)) {
        updateTemperatureField(now);
        applyStatusByTemperature(now);
        updateTempBar(now);
      }
    })();

    /* ===== Точка входа новых данных от устройства =====
       Пример: window.onDeviceState({ temp_c: 72, modem_off:false })
    */
    window.onDeviceState = function (state) {
      if (state?.temp_c != null) {
        const t = Number(state.temp_c);
        updateTemperatureField(t);
        applyStatusByTemperature(t);
        updateTempBar(t);
      }
      if (state?.modem_off) {
        setSystemStatus('off');
        // НЕ скрываем предупреждение, чтобы было видно причину отключения
        // hideOverheatAdvice();
      }
    };

    /* ===== Пуллинг температуры с демо-сервера ===== */
    const API_TEMP_URL = "http://127.0.0.1:8000/api/temp";

    async function pollTemperature() {
      try {
        const r = await fetch(API_TEMP_URL, { cache: "no-store" });
        const data = await r.json();
        if (typeof data?.temp_c !== 'undefined') {
          window.onDeviceState?.({ temp_c: data.temp_c });
        }
      } catch (e) {
        // console.debug("temp poll error", e);
      }
    }
    pollTemperature();
    setInterval(pollTemperature, 2000);
  </script>


  <!-- SVG SPRITE -->
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="0" height="0"
    style="position:absolute;left:-9999px;">
    <defs>
      <symbol id="icon-status-ok" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="currentColor" />
        <path d="M6 12L10 16.5L18.5 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"
          stroke-linejoin="round" />
      </symbol>

      <symbol id="icon-status-err" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="12" fill="currentColor" />
        <path d="M7 17.4497L17.4497 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" />
        <path d="M17.4497 17.4497L7 7" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round" />
      </symbol>

      <symbol id="icon-status-off" viewBox="0 0 28 28">
        <circle cx="14" cy="14" r="13" fill="currentColor" stroke="#fff" stroke-width="2" />
        <path d="M8 14L12 18.5L20.5 9" stroke="#8C8C8C" stroke-width="2" fill="none" stroke-linecap="round"
          stroke-linejoin="round" />
      </symbol>
    </defs>
  </svg>

</body>

</html>